<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; color: #e9edef; overflow-x: hidden; }
        .title { padding: 20px 15px 10px 15px; color: #8696a0; font-size: 14px; font-weight: 500; text-transform: uppercase; }
        
        /* ESTILO DE ITEMS */
        .item { display: flex; align-items: center; padding: 12px 15px; gap: 15px; cursor: pointer; }
        .item:active { background-color: #202c33; }

        .ring-container { position: relative; width: 58px; height: 58px; display: flex; align-items: center; justify-content: center; }
        .img-perfil { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background: #232d36; z-index: 2; }
        
        .status-circle { position: absolute; width: 58px; height: 58px; transform: rotate(-90deg); }
        .status-circle circle { fill: none; stroke: #00a884; stroke-width: 2.5; stroke-linecap: round; }

        .add-icon { position: absolute; bottom: 2px; right: 2px; background: #00a884; color: #0b141a; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; border: 2px solid #0b141a; z-index: 3; }

        /* BOT√ìN FLOTANTE √öNICO DE ESTA P√ÅGINA */
        .fab-estados {
            position: fixed; bottom: 25px; right: 25px;
            background-color: #00a884; width: 56px; height: 56px;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 24px; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 99; cursor: pointer;
        }

        /* VISOR DE ESTADOS (MODAL) */
        #visor-estados { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: black; z-index: 2000; flex-direction: column; 
        }
        .progress-container { display: flex; gap: 5px; padding: 15px 10px; position: absolute; top: 0; width: 95%; z-index: 2001; }
        .bar { flex: 1; height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; background: white; width: 0%; }
        .visor-header { padding: 30px 15px 15px 15px; display: flex; align-items: center; gap: 10px; z-index: 10; color: white; }
        .visor-content { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .visor-content img, .visor-content video { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body>

    <div class="item" onclick="document.getElementById('file-estado').click()">
        <div class="ring-container">
            <svg class="status-circle" viewBox="0 0 40 40">
                <circle id="mi-circulo" cx="20" cy="20" r="18" stroke="#8696a0" fill="none"></circle>
            </svg>
            <img id="mi-foto-perfil" class="img-perfil" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            <div class="add-icon">+</div>
        </div>
        <div style="display:flex; flex-direction:column;">
            <div style="font-weight:bold; font-size:16px;">Mi estado</div>
            <div style="color:#8696a0; font-size:14px;" id="estado-sub">Toca para a√±adir actualizaci√≥n</div>
        </div>
    </div>

    <div class="title">Recientes</div>
    <div id="lista-estados-otros"></div>

    <div class="fab-estados" onclick="document.getElementById('file-estado').click()">üì∑</div>

    <input type="file" id="file-estado" accept="image/*,video/*" style="display:none" onchange="subirEstado(event)" multiple>

    <div id="visor-estados">
        <div class="progress-container" id="barras-progreso"></div>
        <div class="visor-header">
            <img id="visor-avatar" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
            <span id="visor-nombre" style="font-weight:bold; font-size:18px;"></span>
        </div>
        <div class="visor-content" id="visor-media" onclick="siguienteEstado()"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        const miId = localStorage.getItem("user_temp_id");

        // 1. CARGAR MI INFO
        db.ref("usuarios_registrados/" + miId).once("value", s => {
            if(s.exists()) document.getElementById("mi-foto-perfil").src = s.val().foto;
        });

        // 2. SUBIR VARIOS ESTADOS
        function subirEstado(event) {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    db.ref("estados/" + miId).push({
                        url: e.target.result,
                        tipo: file.type.includes("video") ? "video" : "imagen",
                        fecha: Date.now()
                    });
                };
                reader.readAsDataURL(file);
            });
            alert("Subiendo a DNPlus, David...");
        }

        // 3. CARGAR LISTA DE OTROS CON "C√ìDIGO" CORREGIDO
        db.ref("estados").on("value", snapshot => {
            const container = document.getElementById("lista-estados-otros");
            container.innerHTML = "";
            snapshot.forEach(child => {
                const userId = child.key;
                if(userId === miId) return;

                db.ref("usuarios_registrados/" + userId).once("value", u => {
                    const user = u.val() || { nombre: "Usuario", foto: "https://cdn-icons-png.flaticon.com/512/149/149071.png" };
                    const estados = Object.values(child.val());
                    
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "item";
                    itemDiv.onclick = () => mostrarVisor(estados, user.nombre, user.foto);
                    itemDiv.innerHTML = `
                        <div class="ring-container">
                            <svg class="status-circle" viewBox="0 0 40 40">
                                <circle cx="20" cy="20" r="18" stroke="#00a884" stroke-dasharray="${113/estados.length} 1" fill="none"></circle>
                            </svg>
                            <img class="img-perfil" src="${user.foto}">
                        </div>
                        <div style="display:flex; flex-direction:column;">
                            <div style="font-weight:bold; font-size:16px;">${user.nombre}</div>
                            <div style="color:#8696a0; font-size:14px;">Actualizado recientemente</div>
                        </div>`;
                    container.appendChild(itemDiv);
                });
            });
        });

        // 4. L√ìGICA DEL VISOR (DENTRO DEL ARCHIVO)
        let estadosActivos = [];
        let indiceActual = 0;
        let timer;

        function mostrarVisor(lista, nombre, foto) {
            estadosActivos = lista;
            indiceActual = 0;
            document.getElementById("visor-estados").style.display = "flex";
            document.getElementById("visor-nombre").innerText = nombre;
            document.getElementById("visor-avatar").src = foto;
            renderEstado();
        }

        function renderEstado() {
            clearInterval(timer);
            const media = estadosActivos[indiceActual];
            const visorMedia = document.getElementById("visor-media");
            const barras = document.getElementById("barras-progreso");
            
            barras.innerHTML = estadosActivos.map((_, i) => `
                <div class="bar"><div class="bar-fill" id="fill-${i}" style="width: ${i < indiceActual ? '100%' : '0%'}"></div></div>
            `).join("");

            if(media.tipo === "video") {
                visorMedia.innerHTML = `<video src="${media.url}" autoplay id="video-v" style="width:100%"></video>`;
                document.getElementById("video-v").onended = siguienteEstado;
            } else {
                visorMedia.innerHTML = `<img src="${media.url}">`;
                let p = 0;
                timer = setInterval(() => {
                    p += 1;
                    if(document.getElementById(`fill-${indiceActual}`)) {
                        document.getElementById(`fill-${indiceActual}`).style.width = p + "%";
                    }
                    if(p >= 100) siguienteEstado();
                }, 40);
            }
        }

        function siguienteEstado() {
            clearInterval(timer);
            indiceActual++;
            if(indiceActual < estadosActivos.length) renderEstado();
            else document.getElementById("visor-estados").style.display = "none";
        }
    </script>
</body>
</html>
