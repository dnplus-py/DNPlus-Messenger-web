<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNPlus - Estados Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://dnplus-py.github.io/DNPlus-Messenger-web/lista_contactos.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; color: #e9edef; overflow-x: hidden; }
        .title { padding: 20px 15px 10px 15px; color: #8696a0; font-size: 14px; font-weight: 500; text-transform: uppercase; }
        .item { display: flex; align-items: center; padding: 12px 15px; gap: 15px; cursor: pointer; }
        .item:active { background-color: #202c33; }
        .ring-container { position: relative; width: 58px; height: 58px; display: flex; align-items: center; justify-content: center; }
        .img-perfil { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background: #232d36; z-index: 2; }
        .status-circle { position: absolute; width: 58px; height: 58px; transform: rotate(-90deg); }
        .status-circle circle { fill: none; stroke: #00a884; stroke-width: 2.5; stroke-linecap: round; }
        .add-icon { position: absolute; bottom: 2px; right: 2px; background: #00a884; color: #0b141a; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; border: 2px solid #0b141a; z-index: 3; }
        .fab-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .fab-text { background-color: #232d36; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #aebac1; box-shadow: 0 4px 8px rgba(0,0,0,0.3); cursor: pointer; }
        .fab-camera { background-color: #00a884; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; }
        #visor-estados { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; flex-direction: column; }
        .progress-container { display: flex; gap: 5px; padding: 15px 10px; position: absolute; top: 0; width: 100%; z-index: 2001; box-sizing: border-box; }
        .bar { flex: 1; height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; background: white; width: 0%; }
        .visor-header { position: absolute; top: 25px; left: 0; width: 100%; padding: 15px; display: flex; align-items: center; gap: 10px; z-index: 2002; color: white; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); }
        .visor-content { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; text-align: center; padding: 40px; font-size: 28px; font-weight: bold; }
        .visor-content img, .visor-content video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .visor-control { position: absolute; top: 0; height: 100%; width: 50%; z-index: 2003; }
        .left { left: 0; }
        .right { right: 0; }
        #modal-texto { display: none; position: fixed; inset: 0; background: #607d8b; z-index: 3000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #input-estado-texto { background: transparent; border: none; outline: none; color: white; font-size: 32px; text-align: center; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

    <div class="item" onclick="document.getElementById('file-estado').click()">
        <div class="ring-container">
            <svg class="status-circle" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" stroke="#8696a0" fill="none"></circle></svg>
            <img id="mi-foto-perfil" class="img-perfil" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            <div class="add-icon">+</div>
        </div>
        <div>
            <div style="font-weight:bold; font-size:16px;">Mi estado</div>
            <div style="color:#8696a0; font-size:14px;">Añadir actualización</div>
        </div>
    </div>

    <div class="title">Recientes</div>
    <div id="lista-estados-otros"></div>

    <div class="fab-container">
        <div class="fab-text" onclick="abrirEditorTexto()"><i class="fas fa-pen"></i></div>
        <div class="fab-camera" onclick="document.getElementById('file-estado').click()"><i class="fas fa-camera"></i></div>
    </div>

    <div id="modal-texto">
        <div class="absolute top-10 left-5 right-5 flex justify-between text-2xl text-white">
            <i class="fas fa-times" onclick="cerrarEditorTexto()"></i>
            <div class="flex gap-6">
                <i class="fas fa-palette" onclick="cambiarFondo()"></i>
                <i class="fas fa-paper-plane" onclick="subirEstadoTexto()"></i>
            </div>
        </div>
        <textarea id="input-estado-texto" placeholder="Escribe un estado" rows="4"></textarea>
    </div>

    <input type="file" id="file-estado" accept="image/*,video/*" style="display:none" onchange="subirEstadoArchivo(event)" multiple>

    <div id="visor-estados">
        <div class="progress-container" id="barras-progreso"></div>
        <div class="visor-header">
            <i class="fas fa-arrow-left mr-2" onclick="cerrarVisor()"></i>
            <img id="visor-avatar" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
            <span id="visor-nombre" class="font-bold"></span>
        </div>
        <div class="visor-content" id="visor-media"></div>
        <div class="visor-control left" onclick="anteriorEstado()"></div>
        <div class="visor-control right" onmousedown="pausarEstado()" onmouseup="reanudarEstado()" onclick="verificarClick()"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const miId = localStorage.getItem("user_phone") || "595992536184";

        db.ref("usuarios_registrados/" + miId).once("value", s => {
            if(s.exists()) document.getElementById("mi-foto-perfil").src = s.val().foto;
        });

        // SUBIR (Misma lógica para todos)
        function subirEstadoArchivo(event) {
            const exp = Date.now() + (24 * 60 * 60 * 1000);
            Array.from(event.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    db.ref("estados/" + miId).push({
                        url: e.target.result,
                        tipo: file.type.includes("video") ? "video" : "imagen",
                        fecha: Date.now(),
                        expira: exp
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function subirEstadoTexto() {
            const txt = document.getElementById("input-estado-texto").value.trim();
            if(!txt) return;
            const exp = Date.now() + (24 * 60 * 60 * 1000);
            db.ref("estados/" + miId).push({
                mensaje: txt,
                color: colores[colorIdx],
                tipo: "texto",
                fecha: Date.now(),
                expira: exp
            });
            document.getElementById("input-estado-texto").value = "";
            cerrarEditorTexto();
        }

        // CARGAR (Filtra por expira para no duplicar ni mostrar viejos)
        db.ref("estados").on("value", snapshot => {
            const container = document.getElementById("lista-estados-otros");
            container.innerHTML = "";
            const ahora = Date.now();

            snapshot.forEach(child => {
                const userId = child.key;
                if(userId === miId) return;

                const listaValida = Object.values(child.val()).filter(e => e.expira > ahora);
                
                if(listaValida.length > 0) {
                    db.ref("usuarios_registrados/" + userId).once("value", u => {
                        const user = u.val() || { nombre: "Usuario", foto: "" };
                        const item = document.createElement("div");
                        item.className = "item";
                        item.onclick = () => mostrarVisor(listaValida, user.nombre, user.foto);
                        item.innerHTML = `
                            <div class="ring-container">
                                <svg class="status-circle" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" stroke="#00a884" stroke-dasharray="${113/listaValida.length} 2" fill="none"></circle></svg>
                                <img class="img-perfil" src="${user.foto}">
                            </div>
                            <div><div class="font-bold">${user.nombre}</div><div class="text-sm text-[#8696a0]">Reciente</div></div>`;
                        container.appendChild(item);
                    });
                }
            });
        });

        // VISOR Y DEMÁS LOGICA (Se mantiene igual para que funcione tu diseño)
        const colores = ["#607d8b", "#7e57c2", "#ff5722", "#26a69a", "#ec407a", "#2196f3"];
        let colorIdx = 0, estadosActivos = [], idx = 0, pct = 0, timer, pausado = false, clickT = 0;

        function abrirEditorTexto() { document.getElementById("modal-texto").style.display = "flex"; }
        function cerrarEditorTexto() { document.getElementById("modal-texto").style.display = "none"; }
        function cambiarFondo() { colorIdx = (colorIdx + 1) % colores.length; document.getElementById("modal-texto").style.backgroundColor = colores[colorIdx]; }

        function mostrarVisor(lista, nombre, foto) {
            estadosActivos = lista.sort((a,b)=>a.fecha-b.fecha); idx = 0;
            document.getElementById("visor-estados").style.display = "flex";
            document.getElementById("visor-nombre").innerText = nombre;
            document.getElementById("visor-avatar").src = foto;
            render();
        }

        function render() {
            clearInterval(timer); pct = 0; pausado = false;
            const m = estadosActivos[idx];
            const content = document.getElementById("visor-media");
            const bars = document.getElementById("barras-progreso");
            bars.innerHTML = estadosActivos.map((_, i) => `<div class="bar"><div class="bar-fill" id="f-${i}" style="width:${i<idx?'100%':'0%'}"></div></div>`).join("");
            if(m.tipo === "video") {
                content.innerHTML = `<video id="vid" src="${m.url}" autoplay style="width:100%"></video>`;
                const v = document.getElementById("vid");
                v.onloadedmetadata = () => run(v.duration * 1000);
            } else if(m.tipo === "texto") {
                content.innerHTML = `<div class="w-full h-full flex items-center justify-center" style="background:${m.color}">${m.mensaje}</div>`;
                run(4000);
            } else {
                content.innerHTML = `<img src="${m.url}">`;
                run(4000);
            }
        }

        function run(ms) {
            const step = 100, inc = (step/ms)*100;
            timer = setInterval(() => { if(!pausado) { pct += inc; if(document.getElementById(`f-${idx}`)) document.getElementById(`f-${idx}`).style.width = pct + "%"; if(pct >= 100) next(); } }, step);
        }
        function next() { idx < estadosActivos.length - 1 ? (idx++, render()) : cerrarVisor(); }
        function anteriorEstado() { if(idx > 0) { idx--; render(); } }
        function pausarEstado() { pausado = true; if(document.getElementById("vid")) document.getElementById("vid").pause(); clickT = Date.now(); }
        function reanudarEstado() { pausado = false; if(document.getElementById("vid")) document.getElementById("vid").play(); }
        function verificarClick() { if(Date.now() - clickT < 200) next(); }
        function cerrarVisor() { clearInterval(timer); document.getElementById("visor-estados").style.display = "none"; }
    </script>
</body>
</html>
