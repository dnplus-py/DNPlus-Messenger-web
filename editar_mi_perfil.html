<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perfil - DNPlus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        /* Mantenemos tus estilos de colores */
        :root {
            --primary-header: #085f56;
            --button-color: #176f47;
            --bg-dark: #0b141a;
            --text-main: #e9edef;
            --text-muted: #8696a0;
            --input-underline: #2a3942;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; }
        .header { background-color: var(--primary-header); padding: 20px; display: flex; align-items: center; gap: 15px; }
        .profile-container { display: flex; flex-direction: column; align-items: center; padding: 30px 20px; }
        .profile-pic { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; background-color: #111b21; }
        .input-group { width: 100%; max-width: 400px; margin-bottom: 25px; }
        .custom-input { width: 100%; padding: 10px 0; border: none; border-bottom: 1px solid var(--input-underline); background: transparent; color: var(--text-main); outline: none; }
        .update-button { width: 230px; height: 50px; background-color: var(--button-color); color: white; border-radius: 25px; font-weight: 600; cursor: pointer; margin-top: 30px; }
    </style>
</head>
<body>

    <div class="header">
        <div onclick="window.history.back()" style="cursor:pointer">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
        </div>
        <h1 class="text-xl font-semibold">Perfil</h1>
    </div>

    <div class="profile-container">
        <div style="position: relative; margin-bottom: 30px;">
            <img src="https://ui-avatars.com/api/?name=User&background=111b21&color=e9edef" id="profileImage" class="profile-pic">
            <label for="fileInput" style="position: absolute; bottom: 5px; right: 5px; background: var(--button-color); border-radius: 50%; padding: 8px; cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
            </label>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>

        <div class="input-group">
            <label style="color: var(--text-muted); font-size: 13px;">Nombre</label>
            <input type="text" id="inputNombre" class="custom-input" placeholder="Cargando nombre...">
        </div>

        <div class="input-group">
            <label style="color: var(--text-muted); font-size: 13px;">Información</label>
            <input type="text" id="inputBio" class="custom-input" placeholder="!Hola estoy usando DNPlus">
        </div>

        <div class="input-group">
            <label style="color: var(--text-muted); font-size: 13px;">Teléfono</label>
            <input type="text" id="inputTel" class="custom-input" readonly style="opacity: 0.8; border-bottom: 1px dashed #444;">
        </div>

        <button class="update-button" id="btnUpdate">Actualizar</button>
        <p id="statusMsg" style="display: none; color: #F08927; margin-top: 15px;">✓ Perfil actualizado</p>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Obtener el número del almacenamiento o usar el tuyo por defecto
        const userPhone = localStorage.getItem("user_phone") || "595992536184";
        let base64Image = "";

        // CARGA INICIAL
        window.onload = function() {
            // 1. Mostrar el teléfono INMEDIATAMENTE
            document.getElementById('inputTel').value = "+" + userPhone;

            // 2. Traer datos de Firebase
            db.ref("usuarios_registrados/" + userPhone).once("value", (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Solo si hay datos en Firebase, reemplazamos los placeholders
                    if(data.nombre) document.getElementById('inputNombre').value = data.nombre;
                    
                    if(data.bio) {
                        document.getElementById('inputBio').value = data.bio;
                    } else {
                        document.getElementById('inputBio').value = "!Hola estoy usando DNPlus";
                    }

                    if (data.foto) {
                        document.getElementById('profileImage').src = data.foto;
                        base64Image = data.foto;
                    }
                } else {
                    // Si el usuario es nuevo, dejamos la bio por defecto
                    document.getElementById('inputBio').value = "!Hola estoy usando DNPlus";
                }
            });
        };

        // SUBIR FOTO
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    base64Image = event.target.result;
                    document.getElementById('profileImage').src = base64Image;
                };
                reader.readAsDataURL(file);
            }
        });

        // BOTÓN ACTUALIZAR
        document.getElementById('btnUpdate').onclick = function() {
            const btn = this;
            const nuevoNombre = document.getElementById('inputNombre').value;
            const nuevaBio = document.getElementById('inputBio').value;

            btn.disabled = true;
            btn.innerText = "Guardando...";

            db.ref("usuarios_registrados/" + userPhone).update({
                nombre: nuevoNombre,
                bio: nuevaBio,
                foto: base64Image,
                telefono: userPhone // Guardamos el número también por si acaso
            }).then(() => {
                btn.disabled = false;
                btn.innerText = "Actualizar";
                const msg = document.getElementById('statusMsg');
                msg.style.display = "block";
                setTimeout(() => msg.style.display = "none", 3000);
            });
        };
    </script>
</body>
</html>
