<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seleccionar contacto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Forzamos que la página ocupe todo el alto para AppCreator */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            background-color: #0b141a; 
            font-family: sans-serif;
            overflow: hidden; 
        }

        body { display: flex; flex-direction: column; }

        /* TOOLBAR FIJO ESTILO WHATSAPP (Color DNPlus) */
        .toolbar-dn { 
            background-color: #085f56; 
            color: white;
            padding: 15px; 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .toolbar-dn i { font-size: 20px; cursor: pointer; }
        .toolbar-info h3 { margin: 0; font-size: 18px; font-weight: 500; }
        .toolbar-info span { font-size: 12px; color: #cfd8dc; }

        /* Área de scroll */
        .lista-container { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
        }

        /* Filas de Opciones (Nuevo grupo/contacto) */
        .row-opt {
            display: flex; align-items: center; padding: 12px 16px; gap: 15px;
            cursor: pointer; transition: 0.2s;
        }
        .row-opt:active { background-color: #202c33; }
        
        .circle-green {
            width: 40px; height: 40px; border-radius: 50%; background-color: #00a884;
            display: flex; align-items: center; justify-content: center; color: white;
        }

        .title-label {
            padding: 20px 16px 10px; font-size: 13px; color: #8696a0;
            text-transform: uppercase; font-weight: bold;
        }

        /* Estilo de la Lista de Contactos de Firebase */
        .contact-card { 
            display: flex; align-items: center; padding: 12px 16px; gap: 15px; 
            cursor: pointer;
        }
        .contact-card:active { background-color: #232d36; }
        
        .img-user { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background: #232d36; }
        
        .data-user { flex: 1; border-bottom: 0.5px solid rgba(134, 150, 160, 0.1); padding-bottom: 12px; }
        .name-user { font-size: 16px; color: #e9edef; font-weight: 500; }
        .status-user { font-size: 14px; color: #8696a0; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    </style>
</head>
<body>

    <div class="toolbar-dn">
        <i class="fas fa-arrow-left" onclick="window.history.back()"></i>
        <div class="toolbar-info">
            <h3>Seleccionar contacto</h3>
            <span id="total-cont">Cargando...</span>
        </div>
    </div>

    <div class="lista-container">
        <div class="row-opt">
            <div class="circle-green"><i class="fas fa-users"></i></div>
            <div class="name-user">Nuevo grupo</div>
        </div>
        
        <div class="row-opt" onclick="window.location.href='cresr_new_contactos.html'">
            <div class="circle-green"><i class="fas fa-user-plus"></i></div>
            <div class="name-user">Nuevo contacto</div>
            <i class="fas fa-qrcode" style="margin-left: auto; color: #8696a0;"></i>
        </div>

        <div class="title-label">Contactos en DNPlus</div>

        <div id="box-contactos"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        const miId = localStorage.getItem("user_phone");

        function cargarContactos() {
            db.ref("usuarios_registrados").on("value", (snapshot) => {
                const contenedor = document.getElementById("box-contactos");
                const contTxt = document.getElementById("total-cont");
                contenedor.innerHTML = "";
                let count = 0;

                if (!snapshot.exists()) {
                    contTxt.innerText = "0 contactos";
                    return;
                }

                snapshot.forEach((child) => {
                    const id = child.key;
                    const u = child.val();

                    if (id !== miId) {
                        count++;
                        const item = document.createElement("div");
                        item.className = "contact-card";
                        item.innerHTML = `
                            <img src="${u.foto || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="img-user">
                            <div class="data-user">
                                <div class="name-user">${u.nombre || 'Usuario'}</div>
                                <div class="status-user">${u.estado || 'Disponible'}</div>
                            </div>`;
                        
                        item.onclick = () => {
                            localStorage.setItem("chat_destinatario_id", id);
                            localStorage.setItem("chat_destinatario_nombre", u.nombre);
                            localStorage.setItem("chat_destinatario_foto", u.foto);
                            // En AppCreator24, esto cargará la sección de mensajes
                            window.location.href = "mensajes.html";
                        };

                        contenedor.appendChild(item);
                    }
                });
                contTxt.innerText = count + " contactos";
            });
        }
        window.onload = cargarContactos;
    </script>
</body>
</html>
