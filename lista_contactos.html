<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda DNPlus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        html, body { 
            margin: 0; padding: 0; 
            background-color: #0b141a; 
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden;
            position: fixed; 
            top: 0; left: 0;
            z-index: 999999; 
        }

        /* Barra superior estilo WhatsApp/DNPlus */
        .barra-contactos-exclusiva { 
            background-color: #008069; 
            height: 60px; min-height: 60px; width: 100%;
            display: flex; align-items: center; 
            padding: 0 15px; gap: 20px; color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .area-scroll-contactos { 
            flex: 1; overflow-y: auto; background-color: #0b141a;
            padding-bottom: 20px;
        }

        /* Estilo para las filas de contactos y opciones */
        .fila-dn-contacto { 
            display: flex; align-items: center; 
            padding: 12px 16px; gap: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: background 0.2s;
        }
        .fila-dn-contacto:active { background-color: #202c33; }

        .icono-accion {
            width: 45px; height: 45px; border-radius: 50%; 
            background: #00a884; display: flex; 
            align-items: center; justify-content: center;
        }

        .img-perfil-unica { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #232d36; }
        .nombre-unico { font-size: 16px; color: #e9edef; margin: 0; font-weight: 500; }
        .estado-unico { font-size: 13px; color: #8696a0; margin: 0; }

        /* MODAL DE BORRADO */
        #modal-borrar {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            align-items: center; justify-content: center;
            z-index: 1000000;
        }
        .modal-contenido {
            background: #232d36; color: white;
            width: 85%; max-width: 320px;
            padding: 25px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .btn-modal {
            padding: 12px 25px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; margin: 10px 5px;
            width: 110px;
        }
        .btn-si { background: #e53935; color: white; }
        .btn-no { background: transparent; color: #00a884; border: 1px solid #00a884; }
    </style>
</head>
<body id="cuerpo-agenda">

    <div class="barra-contactos-exclusiva">
        <i class="fas fa-arrow-left" onclick="irAtras()" style="cursor:pointer;"></i>
        <div>
            <h3 style="margin:0; font-size:18px;">Seleccionar contacto</h3>
            <span id="txt-total-usuarios" style="font-size:12px; opacity:0.8;">Cargando contactos...</span>
        </div>
    </div>

    <div class="area-scroll-contactos">
        
        <div class="fila-dn-contacto" onclick="alert('Función de grupos próximamente')">
            <div class="icono-accion">
                <i class="fas fa-users" style="color:white; font-size: 18px;"></i>
            </div>
            <p class="nombre-unico">Nuevo grupo</p>
        </div>

        <div class="fila-dn-contacto" onclick="window.location.href='crear_new_contacto.html'">
            <div class="icono-accion">
                <i class="fas fa-user-plus" style="color:white; font-size: 18px;"></i>
            </div>
            <div style="flex:1; display:flex; justify-content:space-between; align-items:center;">
                <p class="nombre-unico">Nuevo contacto</p>
                <i class="fas fa-qrcode" style="color:#8696a0; font-size:18px; margin-right:5px;"></i>
            </div>
        </div>

        <p style="padding: 15px 16px 5px; color: #8696a0; font-size: 13px; text-transform: uppercase; font-weight: bold;">Contactos en DNPlus</p>

        <div id="lista-usuarios-dn-unica"></div>
    </div>

    <div id="modal-borrar">
        <div class="modal-contenido">
            <i class="fas fa-trash-alt" style="font-size: 40px; color: #e53935; margin-bottom: 15px;"></i>
            <h3>¿Eliminar contacto?</h3>
            <p style="color: #8696a0; font-size: 14px;">Se borrará de tu lista de contactos de DNPlus.</p>
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                <button class="btn-modal btn-no" onclick="cerrarModal()">CANCELAR</button>
                <button class="btn-modal btn-si" id="btn-confirmar-borrado">ELIMINAR</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const confDN = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        if (!firebase.apps.length) firebase.initializeApp(confDN);
        const rtdbDN = firebase.database();
        let contactoSeleccionadoID = null;

        function renderizarContactosDN() {
            rtdbDN.ref("usuarios_registrados").on("value", (snapshot) => {
                const contenedor = document.getElementById("lista-usuarios-dn-unica");
                contenedor.innerHTML = "";
                let count = 0;

                snapshot.forEach((hijo) => {
                    const id = hijo.key;
                    const datos = hijo.val();
                    count++;

                    const div = document.createElement("div");
                    div.className = "fila-dn-contacto";
                    div.innerHTML = `
                        <img src="${datos.foto || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="img-perfil-unica">
                        <div style="flex:1;">
                            <p class="nombre-unico">${datos.nombre}</p>
                            <p class="estado-unico">${datos.estado || 'Disponible'}</p>
                        </div>`;

                    // Al tocar, abrir chat
                    div.onclick = () => {
                        localStorage.setItem("chat_destinatario_id", id);
                        localStorage.setItem("chat_destinatario_nombre", datos.nombre);
                        localStorage.setItem("chat_destinatario_foto", datos.foto || "");
                        window.location.href = "mensajes.html";
                    };

                    // Pulsación larga para borrar contacto
                    let timer;
                    const iniciarTimer = () => timer = setTimeout(() => abrirModal(id), 800);
                    const limpiarTimer = () => clearTimeout(timer);

                    div.onmousedown = iniciarTimer;
                    div.onmouseup = limpiarTimer;
                    div.ontouchstart = iniciarTimer;
                    div.ontouchend = limpiarTimer;

                    contenedor.appendChild(div);
                });
                document.getElementById("txt-total-usuarios").innerText = count + " contactos";
            });
        }

        function abrirModal(id) {
            contactoSeleccionadoID = id;
            document.getElementById("modal-borrar").style.display = "flex";
        }

        function cerrarModal() {
            document.getElementById("modal-borrar").style.display = "none";
        }

        document.getElementById("btn-confirmar-borrado").onclick = () => {
            if (contactoSeleccionadoID) {
                rtdbDN.ref("usuarios_registrados/" + contactoSeleccionadoID).remove()
                .then(() => cerrarModal())
                .catch(err => alert("Error al eliminar: " + err));
            }
        };

        function irAtras() {
            // Regresa a la lista de chats principal
            window.location.href = "index.html"; 
        }

        window.onload = renderizarContactosDN;
    </script>
</body>
</html>
