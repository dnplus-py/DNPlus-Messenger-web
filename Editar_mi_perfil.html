<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perfil - DNPlus</title>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; color: #e9edef; }
        .header-edit { background-color: #085f56; color: white; padding: 15px; display: flex; align-items: center; gap: 20px; }
        .profile-section { display: flex; flex-direction: column; align-items: center; padding: 30px 0; }
        .avatar-container { position: relative; width: 160px; height: 160px; }
        .avatar-big { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background-color: #232d36; border: 1px solid rgba(255,255,255,0.1); }
        .btn-change-photo { position: absolute; bottom: 5px; right: 5px; background-color: #085f56; color: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid #0b141a; font-size: 20px; cursor: pointer; }
        .info-item { display: flex; align-items: center; padding: 15px 20px; gap: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .info-icon { color: #8696a0; font-size: 20px; width: 30px; text-align: center; }
        .info-label { font-size: 13px; color: #8696a0; margin-bottom: 2px; }
        .info-value { font-size: 16px; color: #e9edef; border: none; outline: none; width: 100%; background: transparent; }
        .btn-save-profile { position: fixed; bottom: 25px; right: 25px; background-color: #00a884; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: none; font-size: 24px; cursor: pointer; }
        #fileInput { display: none; }
    </style>
</head>
<body>

    <div class="header-edit">
        <span onclick="location.href='ajustes.html'" style="font-size: 24px; cursor: pointer;">‚Üê</span>
        <span style="font-size: 18px; font-weight: bold;">Perfil</span>
    </div>

    <div class="profile-section">
        <div class="avatar-container">
            <img src="https://www.w3schools.com/howto/img_avatar.png" class="avatar-big" id="currentPhoto">
            <div class="btn-change-photo" onclick="document.getElementById('fileInput').click()">üì∑</div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" onchange="actualizarFoto(event)">

    <div class="info-item">
        <div class="info-icon">üë§</div>
        <div style="flex: 1;">
            <div class="info-label">Nombre</div>
            <input type="text" class="info-value" id="editName" placeholder="David Oviedo">
        </div>
        <div style="color: #00a884;">‚úèÔ∏è</div>
    </div>

    <div class="info-item">
        <div class="info-icon">‚ÑπÔ∏è</div>
        <div style="flex: 1;">
            <div class="info-label">Info.</div>
            <input type="text" class="info-value" id="editStatus" placeholder="Hola, estoy usando DNPlus">
        </div>
        <div style="color: #00a884;">‚úèÔ∏è</div>
    </div>

    <div class="info-item">
        <div class="info-icon">üìû</div>
        <div style="flex: 1;">
            <div class="info-label">Tel√©fono</div>
            <input type="text" class="info-value" id="editPhone" placeholder="Tu n√∫mero">
        </div>
    </div>

    <button class="btn-save-profile" onclick="guardarTodo()">‚úì</button>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            authDomain: "dnplus-messenger-pro.firebaseapp.com",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
            projectId: "dnplus-messenger-pro",
            storageBucket: "dnplus-messenger-pro.firebasestorage.app",
            messagingSenderId: "625573378436",
            appId: "1:625573378436:android:58945eb1e22ec4a2ba85d1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // VALORES POR DEFECTO REALES
        const DEFAULT_AVATAR = "https://www.w3schools.com/howto/img_avatar.png";
        const DEFAULT_STATUS = "Hola, estoy usando DNPlus";

        window.onload = function() {
            // Referencia directa a la carpeta del perfil en Firebase
            db.ref("usuarios/mi_perfil").once("value", (snapshot) => {
                const data = snapshot.val();
                
                // Si hay datos en Firebase, √∫salos; si no, usa el default
                if(data) {
                    document.getElementById('editName').value = data.nombre || "David Oviedo";
                    document.getElementById('currentPhoto').src = data.foto || DEFAULT_AVATAR;
                    document.getElementById('editStatus').value = data.estado || DEFAULT_STATUS;
                    document.getElementById('editPhone').value = data.telefono || "";
                } else {
                    // Si no hay datos en Firebase, intentamos LocalStorage o mostramos default puro
                    document.getElementById('editName').value = localStorage.getItem("user_name") || "David Oviedo";
                    document.getElementById('currentPhoto').src = localStorage.getItem("user_photo") || DEFAULT_AVATAR;
                    document.getElementById('editStatus').value = DEFAULT_STATUS;
                }
            });
        }

        function actualizarFoto(event) {
            const reader = new FileReader();
            reader.onload = function(){
                document.getElementById('currentPhoto').src = reader.result;
            };
            if(event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }

        function guardarTodo() {
            const nuevoNombre = document.getElementById('editName').value || "David Oviedo";
            const nuevaFoto = document.getElementById('currentPhoto').src;
            const nuevoEstado = document.getElementById('editStatus').value || DEFAULT_STATUS;
            const nuevoTelefono = document.getElementById('editPhone').value || "";

            // Guardar en Firebase para que sea "real" y no se pierda
            db.ref("usuarios/mi_perfil").update({
                nombre: nuevoNombre,
                foto: nuevaFoto,
                estado: nuevoEstado,
                telefono: nuevoTelefono,
                ultimaActualizacion: Date.now()
            }).then(() => {
                // Sincronizar LocalStorage para navegaci√≥n r√°pida
                localStorage.setItem("user_name", nuevoNombre);
                localStorage.setItem("user_photo", nuevaFoto);
                
                window.location.href = 'ajustes.html';
            }).catch((e) => {
                alert("Error al sincronizar: " + e.message);
            });
        }
    </script>
</body>
</html>
