<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat DNPlus</title>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; display: flex; flex-direction: column; height: 100vh; color: #e9edef; }
        
        /* Cabecera Estilo DNPlus */
        .chat-header { background-color: #085f56; padding: 10px 15px; display: flex; align-items: center; gap: 10px; z-index: 10; }
        .back-icon { font-size: 22px; cursor: pointer; color: white; padding-right: 5px; }
        .user-img { width: 38px; height: 38px; border-radius: 50%; background: #232d36; object-fit: cover; }
        .user-info { flex: 1; }
        .user-info span { display: block; font-weight: bold; font-size: 16px; color: white; }
        .user-info small { color: rgba(255,255,255,0.8); font-size: 12px; }

        /* Contenedor de Mensajes */
        .messages-container {
            flex: 1; padding: 15px; overflow-y: auto;
            background-color: #0b141a; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
            display: flex; flex-direction: column; gap: 8px;
        }

        /* Burbujas */
        .bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        .received { background-color: #202c33; align-self: flex-start; border-top-left-radius: 2px; }
        .sent { background-color: #085f56; align-self: flex-end; border-top-right-radius: 2px; }
        .time { font-size: 10px; color: rgba(255,255,255,0.5); text-align: right; margin-top: 4px; }
        
        .bubble img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        /* Input de Texto */
        .input-wrapper { background-color: transparent; padding: 8px; display: flex; align-items: flex-end; gap: 8px; }
        .input-container { flex: 1; background-color: #202c33; border-radius: 25px; display: flex; align-items: center; padding: 5px 12px; }
        .chat-input { flex: 1; background: transparent; border: none; color: white; font-size: 17px; outline: none; padding: 8px 5px; }
        .icon-btn { color: #8696a0; font-size: 22px; padding: 8px; cursor: pointer; }
        
        /* Bot√≥n de Acci√≥n */
        .action-btn { background-color: #085f56; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: none; flex-shrink: 0; cursor: pointer; }
    </style>
</head>
<body>

    <div class="chat-header">
        <div class="back-icon" onclick="history.back()">‚Üê</div>
        <img class="user-img" id="headerFoto" src="https://www.w3schools.com/howto/img_avatar.png">
        <div class="user-info">
            <span id="chatNombre">Cargando...</span>
            <small>en l√≠nea</small>
        </div>
    </div>

    <div class="messages-container" id="msgContainer"></div>

    <div class="input-wrapper">
        <div class="input-container">
            <div class="icon-btn">üòä</div>
            <input type="text" id="chatInput" class="chat-input" placeholder="Mensaje" oninput="toggleIcon()">
            <div class="icon-btn">üìé</div>
        </div>
        <button class="action-btn" onclick="handleAction()">
            <span id="actionIcon" style="font-size: 22px;">üéôÔ∏è</span>
        </button>
    </div>

    <script>
        let chatActual = "";
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        window.onload = function() {
            chatActual = localStorage.getItem("chat_actual") || "Contacto";
            document.getElementById('chatNombre').innerText = chatActual;
            
            // Cargar historial
            cargarHistorial();

            // Pedir micro
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => guardarMensaje(reader.result, 'audio');
                        audioChunks = [];
                    };
                }).catch(err => console.log("Micro no disponible"));
        };

        function toggleIcon() {
            const input = document.getElementById('chatInput');
            const icon = document.getElementById('actionIcon');
            icon.innerText = input.value.trim() !== "" ? "‚û§" : "üéôÔ∏è";
        }

        function handleAction() {
            const input = document.getElementById('chatInput');
            if (input.value.trim() !== "") {
                guardarMensaje(input.value, 'text');
                input.value = "";
                toggleIcon();
            } else {
                if (!isRecording) {
                    audioChunks = [];
                    mediaRecorder.start();
                    document.getElementById('actionIcon').innerText = "üõë";
                    document.getElementById('actionIcon').style.color = "#ff5252";
                } else {
                    mediaRecorder.stop();
                    document.getElementById('actionIcon').innerText = "üéôÔ∏è";
                    document.getElementById('actionIcon').style.color = "white";
                }
                isRecording = !isRecording;
            }
        }

        function guardarMensaje(contenido, tipo) {
            const now = new Date();
            const time = now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
            const msg = { tipo, contenido, time, sender: 'me' };
            
            let historial = JSON.parse(localStorage.getItem("hist_ " + chatActual)) || [];
            historial.push(msg);
            localStorage.setItem("hist_ " + chatActual, JSON.stringify(historial));
            
            renderMensaje(msg);
        }

        function renderMensaje(m) {
            const container = document.getElementById('msgContainer');
            const bubble = document.createElement('div');
            bubble.className = m.sender === 'me' ? 'bubble sent' : 'bubble received';
            
            if (m.tipo === 'text') {
                bubble.innerHTML = `${m.contenido} <div class="time">${m.time}</div>`;
            } else if (m.tipo === 'audio') {
                bubble.innerHTML = `<audio controls style="width:200px; height:35px;"><source src="${m.contenido}" type="audio/mp3"></audio><div class="time">${m.time}</div>`;
            }
            
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        function cargarHistorial() {
            let historial = JSON.parse(localStorage.getItem("hist_ " + chatActual)) || [];
            historial.forEach(m => renderMensaje(m));
        }
    </script>

<script>
    window.onload = function() {
        // Buscamos el nombre que guardaste en el perfil
        const nombreGuardado = localStorage.getItem("user_name");
        
        if (nombreGuardado) {
            // Si tienes un elemento con id "nombreUsuario", le pone tu nombre
            const el = document.getElementById('nombreUsuario');
            if(el) el.innerText = nombreGuardado;
            
            // Tambi√©n lo actualizamos en el mensaje de soporte
            const msgSoporte = document.querySelector('.msg');
            if(msgSoporte) msgSoporte.innerText = "¬°Bienvenido, " + nombreGuardado + "! üöÄ";
        }
    };
</script>    
</body>
</html>
