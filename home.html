<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNPlus - Chats</title>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; color: white; }
        
        /* CABECERA */
        .header-home { background-color: #085f56; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 20px; font-weight: bold; color: #e9edef; }
        .icons-header { display: flex; gap: 20px; font-size: 20px; cursor: pointer; }

        /* BUSCADOR */
        .search-container { padding: 10px; background-color: #0b141a; }
        .search-bar { background-color: #202c33; border-radius: 10px; display: flex; align-items: center; padding: 5px 15px; }
        .search-bar input { background: transparent; border: none; color: white; padding: 8px; width: 100%; outline: none; }

        /* LISTA DE CHATS */
        .chat-item { display: flex; align-items: center; padding: 12px 15px; gap: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .chat-item:active { background-color: #202c33; }
        .avatar-chat { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #232d36; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-name { font-weight: bold; font-size: 16px; color: #e9edef; }
        .chat-time { font-size: 12px; color: #8696a0; }
        .chat-msg { font-size: 14px; color: #8696a0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* MODAL DE OPCIONES (3 PUNTITOS) */
        #menu-modal { display: none; position: fixed; top: 50px; right: 10px; background: #232d36; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border-radius: 8px; z-index: 1000; width: 180px; }
        .menu-item { padding: 12px 15px; font-size: 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-item:last-child { border-none; }
        .menu-item:active { background-color: #2a3942; }

        /* BOT√ìN FLOTANTE NUEVO CHAT */
        .fab { position: fixed; bottom: 20px; right: 20px; background-color: #00a884; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
    </style>
</head>
<body>

    <div class="header-home">
        <div class="logo">DNPlus</div>
        <div class="icons-header">
            <span>üì∑</span>
            <span onclick="toggleMenu()">‚ãÆ</span>
        </div>
    </div>

    <div id="menu-modal" onclick="toggleMenu()">
        <div class="menu-item" onclick="location.href='perfil.html'">Perfil</div>
        <div class="menu-item" onclick="location.href='ajustes.html'">Ajustes</div>
        <div class="menu-item" style="color: #ff4b4b;">Cerrar sesi√≥n</div>
    </div>

    <div class="search-container">
        <div class="search-bar">
            <span>üîç</span>
            <input type="text" id="busqueda" placeholder="Buscar chats..." oninput="buscarChat()">
        </div>
    </div>

    <div id="lista-chats">
        </div>

    <div class="fab" onclick="location.href='lista_contactos.html'">üí¨</div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            authDomain: "dnplus-messenger-pro.firebaseapp.com",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
            projectId: "dnplus-messenger-pro",
            storageBucket: "dnplus-messenger-pro.firebasestorage.app",
            messagingSenderId: "625573378436",
            appId: "1:625573378436:android:58945eb1e22ec4a2ba85d1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const miId = localStorage.getItem("user_temp_id");

        window.onload = function() {
            cargarChats();
        };

        function cargarChats() {
            // Buscamos en 'chats_privados'
            db.ref("chats_privados").on("value", (snapshot) => {
                const container = document.getElementById("lista-chats");
                container.innerHTML = "";
                
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const salaId = child.key;
                        
                        // Solo mostramos si mi ID es parte del nombre de la sala (ej: 595_541)
                        if (salaId.includes(miId)) {
                            // Sacamos el ID de la otra persona
                            const idOtro = salaId.replace(miId, "").replace("_", "");
                            
                            // Buscamos los datos de esa persona
                            db.ref("usuarios_registrados/" + idOtro).once("value", (uSnap) => {
                                const datosOtro = uSnap.val() || {};
                                const nombre = datosOtro.nombre || "Usuario";
                                const foto = datosOtro.foto || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                                
                                // Obtener el √∫ltimo mensaje
                                const mensajes = Object.values(child.val());
                                const ultimoMsg = mensajes[mensajes.length - 1];
                                const hora = new Date(ultimoMsg.fecha).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                                container.innerHTML += `
                                    <div class="chat-item" onclick="abrirChat('${salaId}', '${idOtro}', '${nombre}', '${foto}')">
                                        <img src="${foto}" class="avatar-chat">
                                        <div class="chat-info">
                                            <div class="chat-top">
                                                <span class="chat-name">${nombre}</span>
                                                <span class="chat-time">${hora}</span>
                                            </div>
                                            <div class="chat-msg">${ultimoMsg.tipo === 'texto' ? ultimoMsg.contenido : 'üì∑ Imagen o üéµ Audio'}</div>
                                        </div>
                                    </div>`;
                            });
                        }
                    });
                }
            });
        }

        function abrirChat(salaId, idOtro, nombre, foto) {
            localStorage.setItem("chat_sala_id", salaId);
            localStorage.setItem("chat_destinatario_id", idOtro);
            localStorage.setItem("chat_destinatario_nombre", nombre);
            localStorage.setItem("chat_destinatario_foto", foto);
            location.href = "mensajes.html";
        }

        function toggleMenu() {
            const modal = document.getElementById("menu-modal");
            modal.style.display = modal.style.display === "block" ? "none" : "block";
        }

        function buscarChat() {
            let filtro = document.getElementById("busqueda").value.toLowerCase();
            let items = document.getElementsByClassName("chat-item");
            for (let item of items) {
                let nombre = item.querySelector(".chat-name").innerText.toLowerCase();
                item.style.display = nombre.includes(filtro) ? "flex" : "none";
            }
        }
    </script>
</body>
</html>
