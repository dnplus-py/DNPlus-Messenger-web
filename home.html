<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNPlus Chat</title>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; display: flex; flex-direction: column; height: 100vh; color: white; overflow: hidden; }
        
        /* Cabecera m√°s alta */
        .header { background-color: #202c33; height: 70px; padding: 0 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 100; }
        .header-info { display: flex; flex-direction: column; }
        .header-info .nombre { font-size: 17px; font-weight: bold; }
        .header-info .estado { font-size: 12px; color: #00a884; transition: 0.3s; }

        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: cover; background-blend-mode: overlay; background-color: #0b141a;
        }

        /* Burbujas */
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; position: relative; font-size: 15px; cursor: pointer; animation: fadeIn 0.3s; }
        .msg-mio { align-self: flex-end; background-color: #176f47; border-bottom-right-radius: 2px; }
        .msg-otro { align-self: flex-start; background-color: #202c33; border-bottom-left-radius: 2px; }

        /* CAJA DE AUDIO (65px x 270px) */
        .audio-wrapper { 
            width: 270px; height: 65px; display: flex; align-items: center; gap: 12px; padding: 0 10px;
        }
        .play-btn { width: 45px; height: 45px; background: none; border: none; color: #00a884; font-size: 30px; cursor: pointer; }
        .audio-wave { flex: 1; height: 3px; background: rgba(255,255,255,0.2); border-radius: 2px; position: relative; }
        .audio-progress { position: absolute; height: 100%; background: #00a884; width: 0%; }

        /* FOTO 240x180 */
        .img-wrapper { width: 240px; height: 180px; overflow: hidden; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .img-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        /* MODALES */
        #zoom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        #zoom-modal img { max-width: 95%; max-height: 80%; border-radius: 10px; }

        #opciones-modal { display: none; position: fixed; bottom: 0; width: 100%; background: #232d36; padding: 15px 0; border-radius: 20px 20px 0 0; z-index: 900; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); }
        .opcion-btn { padding: 15px 25px; display: flex; align-items: center; gap: 15px; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .opcion-btn:active { background: #2a3942; }

        .footer { background-color: #202c33; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .input-area { flex: 1; background-color: #2a3942; border-radius: 25px; display: flex; align-items: center; padding: 5px 15px; }
        input { flex: 1; background: transparent; border: none; padding: 10px; color: white; outline: none; font-size: 16px; }
        .btn-accion { background-color: #00a884; border: none; width: 48px; height: 48px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <span onclick="window.history.back()" style="cursor:pointer; font-size: 22px;">‚Üê</span>
        <div class="header-info">
            <span class="nombre" id="chat-nombre">Cargando...</span>
            <span class="estado" id="chat-estado">conectando...</span>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="footer">
        <div class="input-area">
            <span style="font-size: 22px; cursor: pointer; color: #8696a0;">üòä</span>
            <input type="text" id="msg-input" placeholder="Mensaje" oninput="detectarEstado()">
            <span onclick="document.getElementById('file-input').click()" style="font-size: 22px; cursor: pointer; color: #8696a0; transform: rotate(-45deg);">üìé</span>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="enviarImagen(event)">
        <button class="btn-accion" id="btn-main" onclick="ejecutarAccion()">üéôÔ∏è</button>
    </div>

    <div id="zoom-modal" onclick="this.style.display='none'">
        <img id="zoom-img" src="">
    </div>

    <div id="opciones-modal">
        <div class="opcion-btn" id="btn-borrar" style="color: #ff4b4b;">üóëÔ∏è Borrar mensaje para todos</div>
        <div class="opcion-btn" onclick="cerrarOpciones()">‚Ü©Ô∏è Responder</div>
        <div class="opcion-btn" onclick="cerrarOpciones()">‚û°Ô∏è Reenviar</div>
        <div class="opcion-btn" onclick="cerrarOpciones()" style="border-top: 1px solid #323d45; margin-top: 5px;">‚ùå Cancelar</div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
        authDomain: "dnplus-messenger-pro.firebaseapp.com",
        databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        projectId: "dnplus-messenger-pro",
        storageBucket: "dnplus-messenger-pro.firebasestorage.app",
        messagingSenderId: "625573378436",
        appId: "1:625573378436:android:58945eb1e22ec4a2ba85d1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const nombreContacto = urlParams.get('nombre') || "Amigo";
    document.getElementById('chat-nombre').innerText = nombreContacto;
    const miNombre = localStorage.getItem("user_name") || "David Oviedo";

    // ESTADO REAL "√öLTIMA VEZ"
    function actualizarUltimaVez() {
        const ahora = new Date();
        const hora = ahora.getHours().toString().padStart(2, '0');
        const min = ahora.getMinutes().toString().padStart(2, '0');
        document.getElementById('chat-estado').innerText = `√∫lt. vez hoy a las ${hora}:${min}`;
    }
    actualizarUltimaVez();

    // CARGAR MENSAJES REALES
    db.ref("mensajes").on("value", (snapshot) => {
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = "";
        snapshot.forEach((child) => {
            const data = child.val();
            mostrarMensaje(data.contenido, data.remitente, data.tipo, child.key);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    function mostrarMensaje(contenido, remitente, tipo, key) {
        const chat = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = (remitente === miNombre) ? "msg msg-mio" : "msg msg-otro";
        
        div.oncontextmenu = (e) => { e.preventDefault(); abrirOpciones(key); };

        if (tipo === "texto") {
            div.innerText = contenido;
        } else if (tipo === "imagen") {
            div.innerHTML = `<div class="img-wrapper" onclick="verZoom('${contenido}')"><img src="${contenido}"></div>`;
        } else if (tipo === "audio") {
            div.innerHTML = `
                <div class="audio-wrapper">
                    <button class="play-btn" onclick="reproducirAudio('${contenido}', this)">‚ñ∂Ô∏è</button>
                    <div class="audio-wave"><div class="audio-progress"></div></div>
                    <span style="font-size: 11px; color: #8696a0;">0:04</span>
                </div>`;
        }
        chat.appendChild(div);
    }

    // ENVIAR AUDIO REAL (GRABACI√ìN SIMULADA CON CAJA)
    function enviarAudio() {
        document.getElementById('chat-estado').innerText = "grabando audio...";
        setTimeout(() => {
            db.ref("mensajes").push({ 
                remitente: miNombre, 
                contenido: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", 
                tipo: "audio", 
                fecha: Date.now() 
            });
            document.getElementById('chat-estado').innerText = "en l√≠nea";
            setTimeout(actualizarUltimaVez, 3000);
        }, 2000);
    }

    function reproducirAudio(url, btn) {
        const audio = new Audio(url);
        const progress = btn.parentElement.querySelector('.audio-progress');
        btn.innerText = "‚è∏Ô∏è";
        audio.play();
        audio.ontimeupdate = () => {
            const pct = (audio.currentTime / audio.duration) * 100;
            progress.style.width = pct + "%";
        };
        audio.onended = () => { btn.innerText = "‚ñ∂Ô∏è"; progress.style.width = "0%"; };
    }

    // BORRAR MENSAJE REAL
    let mensajeParaBorrar = null;
    function abrirOpciones(key) {
        mensajeParaBorrar = key;
        document.getElementById('opciones-modal').style.display = 'block';
        document.getElementById('btn-borrar').onclick = () => {
            db.ref("mensajes").child(mensajeParaBorrar).remove();
            cerrarOpciones();
        };
    }

    function cerrarOpciones() { document.getElementById('opciones-modal').style.display = 'none'; }

    function detectarEstado() {
        const input = document.getElementById('msg-input');
        const btn = document.getElementById('btn-main');
        const estado = document.getElementById('chat-estado');
        if (input.value.length > 0) {
            btn.innerHTML = "üïäÔ∏è";
            estado.innerText = "escribiendo...";
        } else {
            btn.innerHTML = "üéôÔ∏è";
            actualizarUltimaVez();
        }
    }

    function ejecutarAccion() {
        const input = document.getElementById('msg-input');
        if (input.value.trim() !== "") {
            db.ref("mensajes").push({ remitente: miNombre, contenido: input.value, tipo: "texto", fecha: Date.now() });
            input.value = "";
            detectarEstado();
        } else {
            enviarAudio();
        }
    }

    function enviarImagen(event) {
        const archivo = event.target.files[0];
        if (archivo) {
            document.getElementById('chat-estado').innerText = "enviando foto...";
            const lector = new FileReader();
            lector.onload = (e) => {
                db.ref("mensajes").push({ remitente: miNombre, contenido: e.target.result, tipo: "imagen", fecha: Date.now() });
                setTimeout(actualizarUltimaVez, 2000);
            };
            lector.readAsDataURL(archivo);
        }
    }

    function verZoom(src) {
        document.getElementById('zoom-img').src = src;
        document.getElementById('zoom-modal').style.display = 'flex';
    }
</script>
</body>
</html>
