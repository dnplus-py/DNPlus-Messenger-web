<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DNPlus - Chat Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --whatsapp-bg: #0b141a;
            --msg-mine: #176f47;
            --msg-theirs: #202c33;
            --text-color: #F08927;
        }

        /* Estructura fija para que nada desaparezca */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--whatsapp-bg); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            margin: 0; 
            overflow: hidden; 
        }

        header { 
            height: 60px;
            background-color: #202c33; 
            color: white; 
            padding: 0 15px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-shrink: 0;
            z-index: 1000;
        }

        #chat-container {
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; 
            background-color: #0b141a;
        }

        .input-area { 
            min-height: 60px;
            background-color: #202c33; 
            padding: 8px 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            flex-shrink: 0;
            z-index: 1000;
        }

        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #232d36; }

        /* Burbujas */
        .bubble { max-width: 85%; padding: 8px 12px; border-radius: 8px; font-size: 0.95rem; color: white; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        .bubble-mine { align-self: flex-end; background-color: var(--msg-mine); border-top-right-radius: 2px; }
        .bubble-theirs { align-self: flex-start; background-color: var(--msg-theirs); border-top-left-radius: 2px; }
        
        .msg-text-mine { color: var(--text-color); font-weight: 500; }
        .msg-info { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 0.65rem; margin-top: 2px; opacity: 0.7; }
        
        /* Input Box */
        .input-box { background: #2a3942; border-radius: 25px; flex: 1; display: flex; align-items: center; padding: 0 12px; height: 45px; }
        .input-box input { background: transparent; border: none; outline: none; flex: 1; color: white; font-size: 16px; margin: 0 8px; }
        .icon-btn { color: #8696a0; font-size: 18px; cursor: pointer; }
        .send-btn { background: #176f47; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: none; flex-shrink: 0; }

        #menu-opciones { display: none; position: fixed; top: 60px; right: 10px; background: #232d36; border-radius: 8px; min-width: 170px; z-index: 5000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); border: 1px solid #3b4a54; }
        .menu-item { padding: 12px 20px; color: #e9edef; cursor: pointer; border-bottom: 1px solid #2a3942; }
    </style>
</head>
<body>

    <div id="menu-opciones">
        <div class="menu-item" onclick="window.location.href='perfil_contacto.html'">ðŸ‘¤ Ver contacto</div>
        <div class="menu-item" onclick="location.reload()">ðŸ”„ Actualizar chat</div>
        <div class="menu-item" style="color:#f15c5c" onclick="cerrarSesion()">ðŸšª Salir</div>
    </div>

    <header>
        <div class="flex items-center">
            <i class="fas fa-arrow-left p-2 mr-1 cursor-pointer" onclick="history.back()"></i>
            <img id="header-photo" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="avatar">
            <div class="ml-3">
                <div id="header-name" class="font-bold text-[15px] text-[#e9edef] truncate max-w-[150px]">Cargando...</div>
                <div id="status-text" class="text-[11px] text-[#8696a0]">en lÃ­nea</div>
            </div>
        </div>
        <div class="flex items-center gap-5 text-[#8696a0]">
            <i class="fas fa-video cursor-pointer"></i>
            <i class="fas fa-phone cursor-pointer"></i>
            <i class="fas fa-ellipsis-v cursor-pointer p-1" onclick="toggleMenu()"></i>
        </div>
    </header>

    <main id="chat-container"></main>

    <div class="input-area">
        <div class="input-box">
            <i class="far fa-smile icon-btn"></i>
            <input type="text" id="chat-input" placeholder="Mensaje" autocomplete="off">
            <i class="fas fa-paperclip icon-btn mr-3" style="transform: rotate(-45deg);"></i>
            <i class="fas fa-camera icon-btn"></i>
        </div>
        <button id="main-action-btn" class="send-btn" onclick="manejarAccion()">
            <i id="action-icon" class="fas fa-microphone"></i>
        </button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        const input = document.getElementById('chat-input');
        const container = document.getElementById('chat-container');
        const actionIcon = document.getElementById('action-icon');

        const miId = localStorage.getItem("user_phone") || localStorage.getItem("chat_destId");
        const salaId = localStorage.getItem("chat_sala_id");
        const idOtro = localStorage.getItem("chat_destinatario_id");

        // Cambiar icono MicrÃ³fono/Enviar
        input.addEventListener('input', () => {
            if(input.value.trim() !== "") {
                actionIcon.className = "fas fa-paper-plane";
            } else {
                actionIcon.className = "fas fa-microphone";
            }
        });

        window.onload = () => {
            if(!miId || !idOtro || !salaId) { window.location.href="lista_chats.html"; return; }

            // Cargar datos del contacto
            db.ref("usuarios_registrados/" + idOtro).on("value", (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    document.getElementById('header-name').innerText = data.nombre || "Usuario DNPlus";
                    if(data.foto) document.getElementById('header-photo').src = data.foto;
                }
            });

            // Cargar mensajes
            db.ref("chats_privados/" + salaId).on("child_added", (snapshot) => {
                const msg = snapshot.val();
                dibujarBurbuja(msg.mensaje, msg.hora, msg.emisor === miId);
            });
        };

        function manejarAccion() {
            const texto = input.value.trim();
            if(texto !== "") {
                const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                db.ref("chats_privados/" + salaId).push({
                    mensaje: texto,
                    hora: hora,
                    emisor: miId,
                    fecha: Date.now()
                });
                input.value = "";
                actionIcon.className = "fas fa-microphone";
            }
        }

        function dibujarBurbuja(texto, hora, esMio) {
            const b = document.createElement('div');
            b.className = esMio ? "bubble bubble-mine" : "bubble bubble-theirs";
            const textoClase = esMio ? "msg-text-mine" : "";
            
            b.innerHTML = `
                <div class="${textoClase}">${texto}</div>
                <div class="msg-info">
                    <span>${hora}</span>
                    ${esMio ? '<i class="fas fa-check-double ml-1 text-[#34B7F1]"></i>' : ''}
                </div>
            `;
            container.appendChild(b);
            container.scrollTo(0, container.scrollHeight);
        }

        function toggleMenu() {
            const m = document.getElementById('menu-opciones');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }

        function cerrarSesion() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
