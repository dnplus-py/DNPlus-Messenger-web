<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --header: #075e54; --fondo: #0b141a; --verde: #00a884; }
        body { margin: 0; font-family: sans-serif; background-color: var(--fondo); display: flex; flex-direction: column; height: 100vh; color: white; overflow: hidden; }
        
        .header { background: var(--header); height: 60px; padding: 0 15px; display: flex; align-items: center; gap: 10px; z-index: 100; }
        .avatar-header { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; background-color: #0b141a;
        }

        /* BURBUJAS */
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 75%; position: relative; font-size: 15px; }
        .msg-mio { align-self: flex-end; background-color: #005c4b; border-bottom-right-radius: 2px; }
        .msg-otro { align-self: flex-start; background-color: #202c33; border-bottom-left-radius: 2px; }
        .hora-msg { font-size: 10px; opacity: 0.6; float: right; margin-top: 5px; margin-left: 8px; }

        /* CONTENEDOR DE IMAGEN (230dp x 180dp aprox) */
        .img-wrapper { width: 230px; height: 180px; overflow: hidden; border-radius: 8px; cursor: pointer; background: #1c272d; }
        .img-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        /* CAJA DE AUDIO (60dp x 255dp) */
        .audio-container { width: 255px; height: 60px; display: flex; align-items: center; gap: 12px; padding: 0 10px; }
        .play-icon { font-size: 30px; color: var(--verde); cursor: pointer; }

        /* FOOTER */
        .footer { background: #1f2c33; padding: 10px; display: flex; align-items: center; gap: 8px; }
        .input-area { flex: 1; background: #2a3942; border-radius: 25px; display: flex; align-items: center; padding: 0 15px; height: 45px; }
        input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 16px; }
        .btn-round { background: var(--verde); border: none; width: 48px; height: 48px; border-radius: 50%; color: white; font-size: 22px; cursor: pointer; }

        /* MODALES */
        .modal-bottom { display: none; position: fixed; bottom: 0; width: 100%; background: #232d36; border-radius: 20px 20px 0 0; z-index: 1000; padding: 15px 0; border-top: 1px solid #313d45; }
        .color-circle { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; margin: 10px; display: inline-block; border: 2px solid rgba(255,255,255,0.2); }

        /* VISOR FULL */
        #visor { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:5000; justify-content:center; align-items:center; }
    </style>
</head>
<body>

    <div class="header">
        <span onclick="history.back()">‚Üê</span>
        <img id="header-foto" class="avatar-header" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
        <div style="flex:1">
            <span id="chat-nombre" style="font-weight:bold; display:block">Cargando...</span>
            <span id="chat-estado" style="font-size:11px; color:#00e676">en l√≠nea</span>
        </div>
        <span onclick="document.getElementById('modal-fondo').style.display='block'" style="cursor:pointer">‚ãÆ</span>
    </div>

    <div id="chat-box"></div>

    <div class="footer">
        <div class="input-area">
            <span>üòä</span>
            <input type="text" id="msg-input" placeholder="Mensaje" oninput="actualizarBoton()">
            <span onclick="document.getElementById('file-input').click()" style="cursor:pointer">üìé</span>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="subirImagen(event)">
        <button id="btn-main" class="btn-round">üéôÔ∏è</button>
    </div>

    <div id="modal-fondo" class="modal-bottom">
        <div style="text-align:center; padding:10px;">
            <div class="color-circle" style="background:#0b141a" onclick="cambiarFondo('#0b141a')"></div>
            <div class="color-circle" style="background:#176f47" onclick="cambiarFondo('#176f47')"></div>
            <div class="color-circle" style="background:#075e54" onclick="cambiarFondo('#075e54')"></div>
            <div class="color-circle" style="background:#3e2723" onclick="cambiarFondo('#3e2723')"></div>
            <div class="color-circle" style="background:#1a237e" onclick="cambiarFondo('#1a237e')"></div>
        </div>
        <div style="text-align:center; color:#8696a0" onclick="this.parentElement.style.display='none'">Cerrar</div>
    </div>

    <div id="visor" onclick="this.style.display='none'"><img id="img-zoom" style="max-width:100%"></div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A", databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const miId = localStorage.getItem("user_temp_id");
    const salaId = localStorage.getItem("chat_sala_id");
    const destId = localStorage.getItem("chat_destinatario_id");

    // 1. CARGAR CHAT Y RENDERIZAR
    db.ref("chats_privados/" + salaId).on("value", snap => {
        const box = document.getElementById('chat-box');
        box.innerHTML = "";
        snap.forEach(child => {
            const m = child.val();
            const esMio = m.emisor === miId;
            const hora = new Date(m.fecha).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const div = document.createElement("div");
            div.className = `msg ${esMio ? 'msg-mio' : 'msg-otro'}`;

            if(m.tipo === "imagen") {
                div.innerHTML = `<div class="img-wrapper"><img src="${m.contenido}" onclick="zoom('${m.contenido}')"></div><span class="hora-msg">${hora}</span>`;
            } else if(m.tipo === "audio") {
                div.innerHTML = `<div class="audio-container"><span class="play-icon" onclick="new Audio('${m.contenido}').play()">‚ñ∂Ô∏è</span><div style="flex:1;height:3px;background:#8696a0"></div><span class="hora-msg">${hora}</span></div>`;
            } else if(m.contenido === "‚ù§Ô∏è") {
                div.innerHTML = `<span style="font-size:50px; display:block">‚ù§Ô∏è</span><span class="hora-msg">${hora}</span>`;
            } else {
                div.innerHTML = `<span>${m.contenido}</span><span class="hora-msg">${hora}</span>`;
            }
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    });

    // 2. AUDIO (L√ìGICA MEJORADA)
    let mediaRecorder; let chunks = [];
    const btn = document.getElementById('btn-main');

    btn.onmousedown = () => {
        if(document.getElementById('msg-input').value.length > 0) { enviarTexto(); return; }
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            chunks = [];
            btn.style.background = "red";
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
        });
    };

    btn.onmouseup = () => {
        if(!mediaRecorder || mediaRecorder.state === "inactive") return;
        mediaRecorder.stop();
        btn.style.background = "var(--verde)";
        mediaRecorder.onstop = () => {
            const reader = new FileReader();
            reader.readAsDataURL(new Blob(chunks, { type: 'audio/mp3' }));
            reader.onloadend = () => {
                db.ref("chats_privados/" + salaId).push({ emisor: miId, contenido: reader.result, tipo: "audio", fecha: Date.now() });
            };
        };
    };

    // 3. OTRAS FUNCIONES
    function enviarTexto() {
        const txt = document.getElementById('msg-input').value;
        db.ref("chats_privados/" + salaId).push({ emisor: miId, contenido: txt, tipo: "texto", fecha: Date.now() });
        document.getElementById('msg-input').value = "";
        actualizarBoton();
    }

    function subirImagen(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { db.ref("chats_privados/" + salaId).push({ emisor: miId, contenido: ev.target.result, tipo: "imagen", fecha: Date.now() }); };
        reader.readAsDataURL(e.target.files[0]);
    }

    function actualizarBoton() {
        btn.innerText = document.getElementById('msg-input').value.length > 0 ? "üïäÔ∏è" : "üéôÔ∏è";
    }

    function cambiarFondo(color) {
        document.getElementById('chat-box').style.backgroundColor = color;
        localStorage.setItem("fondo_chat", color);
    }

    function zoom(src) { document.getElementById('visor').style.display='flex'; document.getElementById('img-zoom').src=src; }
</script>
</body>
</html>
