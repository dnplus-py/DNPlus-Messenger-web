<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNPlus Chat</title>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; display: flex; flex-direction: column; height: 100vh; color: white; }
        .header { background-color: #075e54; padding: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        
        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: contain;
        }

        .msg-mio { 
            align-self: flex-end; background-color: #176f47; color: white; padding: 10px; 
            border-radius: 15px 15px 0px 15px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Estilo para mensajes recibidos (otros) */
        .msg-otro { 
            align-self: flex-start; background-color: #202c33; color: white; padding: 10px; 
            border-radius: 0px 15px 15px 15px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .img-enviada { max-width: 100%; border-radius: 10px; display: block; margin-top: 5px; }
        .footer { background-color: #1f2c33; padding: 10px; display: flex; align-items: center; gap: 10px; }
        input { flex: 1; background-color: #2a3942; border: none; padding: 12px; border-radius: 25px; color: white; outline: none; }
        .btn-accion { background-color: #00a884; border: none; width: 48px; height: 48px; border-radius: 50%; color: white; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="header">
        <span onclick="window.history.back()" style="cursor:pointer">‚Üê</span>
        <span>Cargando...</span>
    </div>

    <div id="chat-box"></div>

    <div class="footer">
        <span style="font-size: 22px; cursor: pointer; color: #8696a0; margin-right: 5px;">üòä</span>
        <span onclick="document.getElementById('file-input').click()" style="font-size: 22px; cursor: pointer; color: #8696a0; margin-right: 10px; transform: rotate(-45deg); display: inline-block;">üìé</span>
        <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="enviarImagen(event)">
        <input type="text" id="msg-input" placeholder="Mensaje" oninput="cambiarIcono()">
        <button class="btn-accion" id="btn-main" onclick="ejecutarAccion()">üéôÔ∏è</button>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    // Configuraci√≥n DNPlus
    const firebaseConfig = {
        apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
        authDomain: "dnplus-messenger-pro.firebaseapp.com",
        databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        projectId: "dnplus-messenger-pro",
        storageBucket: "dnplus-messenger-pro.firebasestorage.app",
        messagingSenderId: "625573378436",
        appId: "1:625573378436:android:58945eb1e22ec4a2ba85d1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Identificar el chat y el usuario
    const urlParams = new URLSearchParams(window.location.search);
    const nombreContacto = urlParams.get('nombre') || "Soporte DNPlus";
    document.querySelector('.header span:last-child').innerText = nombreContacto;

    const miNombre = localStorage.getItem("user_name") || "David Oviedo";

    // ESCUCHAR MENSAJES EN TIEMPO REAL
    db.ref("mensajes").on("child_added", (snapshot) => {
        const data = snapshot.val();
        mostrarMensaje(data.contenido, data.remitente, data.tipo);
    });

    function mostrarMensaje(contenido, remitente, tipo) {
        const chat = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = (remitente === miNombre) ? "msg-mio" : "msg-otro";

        if (tipo === "texto") {
            div.innerText = contenido;
        } else if (tipo === "imagen") {
            div.innerHTML = `<img src="${contenido}" class="img-enviada">`;
        }

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function enviarTexto(texto) {
        db.ref("mensajes").push({
            remitente: miNombre,
            contenido: texto,
            tipo: "texto",
            fecha: Date.now()
        });
    }

    function enviarImagen(event) {
        const archivo = event.target.files[0];
        if (archivo) {
            const lector = new FileReader();
            lector.onload = function(e) {
                db.ref("mensajes").push({
                    remitente: miNombre,
                    contenido: e.target.result,
                    tipo: "imagen",
                    fecha: Date.now()
                });
            };
            lector.readAsDataURL(archivo);
        }
    }

    // L√≥gica de interfaz (Iconos y Voz)
    function cambiarIcono() {
        const input = document.getElementById('msg-input');
        const boton = document.getElementById('btn-main');
        boton.innerHTML = input.value.trim() !== "" ? "üïäÔ∏è" : "üéôÔ∏è";
    }

    function ejecutarAccion() {
        const input = document.getElementById('msg-input');
        if (input.value.trim() !== "") {
            enviarTexto(input.value);
            input.value = ""; 
            cambiarIcono();
        } else {
            controlarVoz();
        }
    }

    // (Aqu√≠ va tu funci√≥n de controlarVoz y reproducirAudio que ya ten√≠as)
    // ... mant√©n el c√≥digo de audio que ten√≠as abajo ...
</script>
</body>
</html>
