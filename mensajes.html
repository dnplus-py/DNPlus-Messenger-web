<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNPlus Chat</title>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; display: flex; flex-direction: column; height: 100vh; color: white; }
        .header { background-color: #075e54; padding: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        
        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: contain;
        }

        .msg-mio { 
            align-self: flex-end; background-color: #176f47; color: white; padding: 10px; 
            border-radius: 15px 15px 0px 15px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Estilo para las im√°genes enviadas */
        .img-enviada { max-width: 100%; border-radius: 10px; display: block; margin-top: 5px; }

        .footer { background-color: #1f2c33; padding: 10px; display: flex; align-items: center; gap: 10px; }
        
        input { flex: 1; background-color: #2a3942; border: none; padding: 12px; border-radius: 25px; color: white; outline: none; }

        .iconos-extra { font-size: 22px; cursor: pointer; color: #8696a0; }
        
        .btn-accion { background-color: #00a884; border: none; width: 48px; height: 48px; border-radius: 50%; color: white; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="header">
        <span onclick="window.history.back()" style="cursor:pointer">‚Üê</span>
        <span>Soporte DNPlus</span>
    </div>

    <div id="chat-box"></div>

    <div class="footer">
        <span class="iconos-extra">üòä</span>
        
        <span class="iconos-extra" onclick="document.getElementById('file-input').click()">üìé</span>
        <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="enviarImagen(event)">

        <input type="text" id="msg-input" placeholder="Mensaje" oninput="cambiarIcono()">
        
        <button class="btn-accion" id="btn-main" onclick="ejecutarAccion()">üéôÔ∏è</button>
    </div>

<script>
    let grabador;
    let fragmentos = [];

    function cambiarIcono() {
        const input = document.getElementById('msg-input');
        const boton = document.getElementById('btn-main');
        boton.innerHTML = input.value.trim() !== "" ? "üïäÔ∏è" : "üéôÔ∏è";
    }

    function ejecutarAccion() {
        const input = document.getElementById('msg-input');
        if (input.value.trim() !== "") {
            enviarTexto(input.value);
            input.value = ""; 
            cambiarIcono();
        } else {
            controlarVoz();
        }
    }

    function enviarTexto(texto) {
        const chat = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = "msg-mio";
        div.innerText = texto;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    // NUEVA FUNCI√ìN PARA ENVIAR IM√ÅGENES
    function enviarImagen(event) {
        const archivo = event.target.files[0];
        if (archivo) {
            const lector = new FileReader();
            lector.onload = function(e) {
                const chat = document.getElementById('chat-box');
                const div = document.createElement('div');
                div.className = "msg-mio";
                div.innerHTML = `<img src="${e.target.result}" class="img-enviada">`;
                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;
            };
            lector.readAsDataURL(archivo);
        }
    }

    async function controlarVoz() {
        const boton = document.getElementById('btn-main');
        if (!grabador || grabador.state === "inactive") {
            try {
                const flujo = await navigator.mediaDevices.getUserMedia({ audio: true });
                grabador = new MediaRecorder(flujo);
                fragmentos = [];
                grabador.ondataavailable = (e) => fragmentos.push(e.data);
                
                grabador.onstop = () => {
                    const blobAudio = new Blob(fragmentos, { type: 'audio/mp3' });
                    const urlAudio = URL.createObjectURL(blobAudio);
                    const chat = document.getElementById('chat-box');
                    const divAudio = document.createElement('div');
                    divAudio.className = "msg-mio";
                    divAudio.style.minWidth = "180px";

                    divAudio.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="reproducirAudio(this)" style="background:orange; border:none; color:white; border-radius:5px; cursor:pointer;">‚ñ∂</button>
                            <audio src="${urlAudio}" ontimeupdate="actualizarTiempo(this)"></audio>
                            <span class="tiempo" style="font-size: 12px;">0:00</span>
                            <div style="flex:1; height:3px; background: rgba(255,255,255,0.2); position:relative;">
                                <div class="progreso" style="width:0%; height:100%; background:white;"></div>
                            </div>
                        </div>
                    `;
                    chat.appendChild(divAudio);
                    chat.scrollTop = chat.scrollHeight;
                };
                grabador.start();
                boton.innerHTML = "üõë";
            } catch (error) { alert("Permiso denegado"); }
        } else {
            grabador.stop();
            boton.innerHTML = "üéôÔ∏è";
        }
    }

    function reproducirAudio(btn) {
        const audio = btn.nextElementSibling;
        if (audio.paused) { audio.play(); btn.innerText = "‚è∏"; } 
        else { audio.pause(); btn.innerText = "‚ñ∂"; }
        audio.onended = () => btn.innerText = "‚ñ∂";
    }

    function actualizarTiempo(audio) {
        const spanTiempo = audio.parentElement.querySelector('.tiempo');
        const barra = audio.parentElement.querySelector('.progreso');
        let seg = Math.floor(audio.currentTime);
        spanTiempo.innerText = "0:" + (seg < 10 ? "0" + seg : seg);
        barra.style.width = (audio.currentTime / audio.duration) * 100 + "%";
    }
</script>
</body>
</html>
