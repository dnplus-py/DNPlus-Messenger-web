<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNPlus Chat</title>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0b141a; display: flex; flex-direction: column; height: 100vh; color: white; overflow: hidden; }
        
        /* CABECERA CORREGIDA (#085f56) */
        .header { 
            background-color: #085f56; height: 65px; padding: 0 15px; 
            display: flex; align-items: center; gap: 12px; color: white;
        }
        .header-info { display: flex; flex-direction: column; }
        .header-info .nombre { font-size: 17px; font-weight: bold; }
        .header-info .estado { font-size: 12px; opacity: 0.9; }

        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-color: #0b141a; background-blend-mode: overlay;
        }

        /* BURBUJA DE AUDIO ESTILO WHATSAPP */
        .msg-audio { 
            width: 270px; height: 65px; display: flex; align-items: center; 
            padding: 0 12px; gap: 10px; border-radius: 12px; position: relative;
        }
        .play-btn { font-size: 28px; cursor: pointer; color: #8696a0; }
        .audio-wave-container { flex: 1; display: flex; align-items: center; position: relative; height: 30px; }
        .audio-img { width: 100%; height: 20px; opacity: 0.5; filter: invert(1); }
        .user-avatar-audio { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }

        .msg-mio { align-self: flex-end; background-color: #176f47; border-bottom-right-radius: 2px; }
        .msg-otro { align-self: flex-start; background-color: #202c33; border-bottom-left-radius: 2px; }

        /* FOOTER Y GRABACI√ìN */
        .footer { background-color: #1f2c33; padding: 10px; display: flex; align-items: center; gap: 10px; position: relative; }
        .input-area { flex: 1; background-color: #2a3942; border-radius: 25px; display: flex; align-items: center; padding: 5px 15px; }
        input { flex: 1; background: transparent; border: none; padding: 10px; color: white; outline: none; font-size: 16px; }
        
        .cronometro { display: none; color: #ff4b4b; font-weight: bold; margin-left: 10px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .btn-accion { background-color: #00a884; border: none; width: 50px; height: 50px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <span onclick="window.history.back()" style="cursor:pointer; font-size: 22px;">‚Üê</span>
        <div class="header-info">
            <span class="nombre" id="chat-nombre">Nombre</span>
            <span class="estado" id="chat-estado">en l√≠nea</span>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="footer">
        <div class="input-area" id="input-box">
            <span style="font-size: 22px; cursor: pointer; color: #8696a0;">üòä</span>
            <input type="text" id="msg-input" placeholder="Mensaje" oninput="cambiarIcono()">
            <span id="crono" class="cronometro">0:00</span>
            <span id="clip" onclick="document.getElementById('file-input').click()" style="font-size: 22px; cursor: pointer; color: #8696a0; transform: rotate(-45deg); margin-left: 10px;">üìé</span>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="enviarImagen(event)">
        <button class="btn-accion" id="btn-main" onmousedown="iniciarGrabacion()" onmouseup="finalizarGrabacion()" ontouchstart="iniciarGrabacion()" ontouchend="finalizarGrabacion()">üéôÔ∏è</button>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
        authDomain: "dnplus-messenger-pro.firebaseapp.com",
        databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        projectId: "dnplus-messenger-pro",
        storageBucket: "dnplus-messenger-pro.firebasestorage.app",
        messagingSenderId: "625573378436",
        appId: "1:625573378436:android:58945eb1e22ec4a2ba85d1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Nombre real desde URL
    const urlParams = new URLSearchParams(window.location.search);
    const contactoNom = urlParams.get('nombre') || "Usuario";
    document.getElementById('chat-nombre').innerText = contactoNom;
    const miNom = localStorage.getItem("user_name") || "David";

    // Cron√≥metro y Audio
    let tiempo = 0;
    let intervalo;
    const beep = new Audio('https://www.soundjay.com/buttons/beep-07a.mp3');

    function iniciarGrabacion() {
        if (document.getElementById('msg-input').value.length > 0) return;
        beep.play();
        document.getElementById('msg-input').style.display = 'none';
        document.getElementById('clip').style.display = 'none';
        document.getElementById('crono').style.display = 'inline';
        tiempo = 0;
        intervalo = setInterval(() => {
            tiempo++;
            let min = Math.floor(tiempo / 60);
            let seg = tiempo % 60;
            document.getElementById('crono').innerText = `${min}:${seg < 10 ? '0'+seg : seg}`;
        }, 1000);
    }

    function finalizarGrabacion() {
        if (document.getElementById('msg-input').value.length > 0) {
            enviarMensaje();
            return;
        }
        clearInterval(intervalo);
        document.getElementById('msg-input').style.display = 'block';
        document.getElementById('clip').style.display = 'block';
        document.getElementById('crono').style.display = 'none';
        document.getElementById('crono').innerText = "0:00";
        
        // Enviar burbuja de audio
        db.ref("mensajes").push({
            remitente: miNom,
            tipo: "audio",
            contenido: "https://www.cjoint.com/doc/23_10/MJDv7A6qX8B_visto-por-ultima-vez.mp3", // Solo ejemplo
            fecha: Date.now()
        });
    }

    // Renderizar mensajes
    db.ref("mensajes").on("child_added", (snap) => {
        const m = snap.val();
        const chat = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = (m.remitente === miNom) ? "msg-mio" : "msg-otro";

        if (m.tipo === "audio") {
            div.className += " msg-audio";
            div.innerHTML = `
                <span class="play-btn">‚ñ∂Ô∏è</span>
                <div class="audio-wave-container">
                    <img class="audio-img" src="https://cdn-icons-png.flaticon.com/512/5948/5948543.png">
                </div>
                <img class="user-avatar-audio" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            `;
        } else {
            div.style.padding = "10px";
            div.style.borderRadius = "10px";
            div.style.maxWidth = "75%";
            div.innerText = m.contenido;
        }

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    });

    function cambiarIcono() {
        const input = document.getElementById('msg-input');
        const btn = document.getElementById('btn-main');
        btn.innerHTML = input.value.length > 0 ? "üïäÔ∏è" : "üéôÔ∏è";
    }

    function enviarMensaje() {
        const input = document.getElementById('msg-input');
        if (input.value.trim() !== "") {
            db.ref("mensajes").push({ remitente: miNom, contenido: input.value, tipo: "texto", fecha: Date.now() });
            input.value = "";
            cambiarIcono();
        }
    }
</script>
</body>
</html>
