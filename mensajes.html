<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNPlus Chat</title>
    <style>
        /* FONDO NOCHE TOTAL */
        body { 
            margin: 0; font-family: sans-serif; 
            background-color: #0b141a; /* Negro azulado WhatsApp */
            display: flex; flex-direction: column; height: 100vh; color: white; 
        }

        .header { 
            background-color: #202c33; padding: 10px 15px; 
            display: flex; align-items: center; gap: 10px; 
            position: sticky; top: 0; z-index: 100;
        }

        .header-info { display: flex; flex-direction: column; }
        .header-info .nombre { font-size: 16px; font-weight: bold; }
        .header-info .estado { font-size: 11px; color: #00a884; }

        /* CHAT BOX CON FONDO DE DOODLES OSCURO */
        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: multiply; background-color: #0b141a;
        }

        /* BURBUJAS */
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 75%; font-size: 15px; position: relative; cursor: pointer; }
        .msg-mio { align-self: flex-end; background-color: #005c4b; border-bottom-right-radius: 2px; }
        .msg-otro { align-self: flex-start; background-color: #202c33; border-bottom-left-radius: 2px; }

        /* CONTENEDOR DE FOTO FIJO 240x180 */
        .img-wrapper { 
            width: 240px; height: 180px; 
            border-radius: 8px; overflow: hidden; 
            margin: 2px 0; border: 1px solid rgba(255,255,255,0.1);
        }
        .img-wrapper img { width: 100%; height: 100%; object-fit: cover; cursor: zoom-in; }

        /* MODAL ZOOM */
        #zoom-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; 
        }
        #zoom-modal img { max-width: 95%; max-height: 85%; border-radius: 5px; }

        /* FOOTER */
        .footer { background-color: #202c33; padding: 10px; display: flex; align-items: center; gap: 8px; }
        .input-container { flex: 1; background-color: #2a3942; border-radius: 25px; display: flex; align-items: center; padding: 5px 12px; }
        input[type="text"] { flex: 1; background: transparent; border: none; padding: 10px; color: white; outline: none; font-size: 16px; }
        
        .btn-accion { 
            background-color: #00a884; border: none; width: 45px; height: 45px; 
            border-radius: 50%; color: white; display: flex; align-items: center; 
            justify-content: center; font-size: 20px; cursor: pointer; 
        }

        /* MODAL OPCIONES */
        #modal-opciones {
            display: none; position: fixed; bottom: 0; width: 100%; background: #232d36;
            border-radius: 20px 20px 0 0; padding: 15px 0; z-index: 999;
        }
        .opt-item { padding: 15px 25px; display: flex; align-items: center; gap: 15px; font-size: 16px; }
        .opt-item:active { background: #2a3942; }
    </style>
</head>
<body>

    <div class="header">
        <span onclick="window.history.back()" style="cursor:pointer; font-size: 20px;">‚Üê</span>
        <div class="header-info">
            <span class="nombre" id="nombreChat">Cargando...</span>
            <span class="estado" id="estadoChat">√∫lt. vez hoy 10:45</span>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="footer">
        <div class="input-container">
            <span style="font-size: 22px; cursor: pointer; color: #8696a0;">üòä</span>
            <input type="text" id="msg-input" placeholder="Mensaje" oninput="cambiarIcono()">
            <span onclick="document.getElementById('file-input').click()" style="font-size: 22px; cursor: pointer; color: #8696a0; transform: rotate(-45deg);">üìé</span>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="enviarImagen(event)">
        <button class="btn-accion" id="btn-main" onclick="ejecutarAccion()">üéôÔ∏è</button>
    </div>

    <div id="zoom-modal" onclick="this.style.display='none'">
        <img id="zoom-img" src="">
    </div>

    <div id="modal-opciones" onclick="this.style.display='none'">
        <div class="opt-item">üóëÔ∏è Borrar chat</div>
        <div class="opt-item">‚Ü©Ô∏è Responder</div>
        <div class="opt-item">‚û°Ô∏è Reenviar</div>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
        authDomain: "dnplus-messenger-pro.firebaseapp.com",
        databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        projectId: "dnplus-messenger-pro",
        storageBucket: "dnplus-messenger-pro.firebasestorage.app",
        messagingSenderId: "625573378436",
        appId: "1:625573378436:android:58945eb1e22ec4a2ba85d1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const contacto = urlParams.get('nombre') || "Amigo";
    document.getElementById('nombreChat').innerText = contacto;
    const miUser = localStorage.getItem("user_name") || "David";

    // ESCUCHAR MENSAJES
    db.ref("mensajes").on("child_added", (snap) => {
        const m = snap.val();
        renderMessage(m.contenido, m.remitente, m.tipo, snap.key);
    });

    function renderMessage(cont, rem, tipo, key) {
        const chat = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = (rem === miUser) ? "msg msg-mio" : "msg msg-otro";
        
        // Al pulsar largo o click, mostrar modal
        div.onclick = () => document.getElementById('modal-opciones').style.display = 'block';

        if (tipo === "texto") {
            div.innerText = cont;
        } else if (tipo === "imagen") {
            div.innerHTML = `<div class="img-wrapper" onclick="openZoom('${cont}')"><img src="${cont}"></div>`;
            updateEstado("enviando foto...");
        }

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function cambiarIcono() {
        const val = document.getElementById('msg-input').value;
        const btn = document.getElementById('btn-main');
        if(val.length > 0) {
            btn.innerHTML = "üïäÔ∏è";
            updateEstado("escribiendo...");
        } else {
            btn.innerHTML = "üéôÔ∏è";
            updateEstado("en l√≠nea");
        }
    }

    function updateEstado(txt) {
        const est = document.getElementById('estadoChat');
        est.innerText = txt;
        if(txt !== "en l√≠nea") setTimeout(() => est.innerText = "en l√≠nea", 3000);
    }

    function ejecutarAccion() {
        const input = document.getElementById('msg-input');
        if(input.value.trim() !== "") {
            db.ref("mensajes").push({ remitente: miUser, contenido: input.value, tipo: "texto" });
            input.value = "";
            cambiarIcono();
        } else {
            // SIMULACI√ìN AUDIO
            updateEstado("grabando audio... üéôÔ∏è");
            setTimeout(() => {
                db.ref("mensajes").push({ remitente: miUser, contenido: "üé§ Audio enviado", tipo: "texto" });
                updateEstado("en l√≠nea");
            }, 2000);
        }
    }

    function enviarImagen(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                db.ref("mensajes").push({ remitente: miUser, contenido: ev.target.result, tipo: "imagen" });
            };
            reader.readAsDataURL(file);
        }
    }

    function openZoom(src) {
        event.stopPropagation(); // Evita que se abra el modal de borrar
        document.getElementById('zoom-img').src = src;
        document.getElementById('zoom-modal').style.display = 'flex';
    }
</script>
</body>
</html>
