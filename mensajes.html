// CONFIGURACIÓN FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
    databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const input = document.getElementById('chat-input');
const icon = document.getElementById('action-icon');
const container = document.getElementById('chat-container');

// --- 1. CARGAR DATOS DEL PERFIL DEL CONTACTO ---
window.onload = () => {
    // Obtenemos el ID del usuario con el que estamos hablando
    // (Esto lo podrías pasar por la URL o guardarlo al tocar un contacto)
    const contactoId = localStorage.getItem("chat_con_id") || "12345"; // ID de ejemplo

    db.ref("usuarios/" + contactoId).on("value", (snapshot) => {
        const data = snapshot.val();
        if(data) {
            // Actualizamos Nombre y Foto en el Header y Llamada
            document.getElementById('header-name').innerText = data.nombre;
            document.getElementById('call-name').innerText = data.nombre;
            document.querySelectorAll('.avatar, .call-avatar-big').forEach(img => {
                img.src = data.foto || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            });
        }
    });

    // --- 2. ESCUCHAR MENSAJES EN TIEMPO REAL ---
    db.ref("mensajes").on("child_added", (snapshot) => {
        const msg = snapshot.val();
        const miTelefono = localStorage.getItem("user_phone");
        
        // Si el mensaje no es mío, lo dibujo a la izquierda
        if (msg.usuario !== miTelefono) {
            renderBubble(msg.texto, msg.hora, false);
        }
    });
};

// --- 3. FUNCIÓN PARA DIBUJAR BURBUJAS ---
function renderBubble(texto, hora, esMio) {
    const b = document.createElement('div');
    b.className = esMio ? "bubble bubble-mine" : "bubble bubble-theirs";
    
    // Estilo para mensajes de otros (blanco)
    if(!esMio) {
        b.style.alignSelf = "flex-start";
        b.style.backgroundColor = "white";
        b.style.color = "black";
    }

    b.innerHTML = `
        <div class="${esMio ? 'msg-text-custom' : ''}">${texto}</div>
        <div class="msg-info" style="${!esMio ? 'color:#666' : ''}">
            <span>${hora}</span>
            ${esMio ? '<i class="fas fa-check-double double-check"></i>' : ''}
        </div>`;
    
    container.appendChild(b);
    container.scrollTop = container.scrollHeight;
}

function enviarMensaje() {
    const texto = input.value.trim();
    if(!texto) return;

    const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const miTelefono = localStorage.getItem("user_phone") || "anonimo";

    // Subir a Firebase
    db.ref("mensajes").push({
        texto: texto,
        hora: hora,
        usuario: miTelefono
    });

    // Dibujamos el mío inmediatamente
    renderBubble(texto, hora, true);
    
    input.value = "";
    icon.className = "fas fa-microphone";
}
