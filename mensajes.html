<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - DNPlus</title>
    <style>
        recorder.onstop = () => {
    cons

        /* Ajuste total de la pantalla */
        body { 
            margin: 0; 
            font-family: sans-serif; 
            background-color: #0b141a; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            color: white;
        }

        /* Encabezado fijo */
        .header { 
            background-color: #075e54; 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            font-weight: bold;
        }

        /* BANDEJA DE CHAT: Se ajusta sola y tiene scroll */
        #chat-box { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: contain;
        }

        /* Barra de entrada de mensajes */
        .footer { 
            background-color: #1f2c33; 
            padding: 10px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        input { 
            flex: 1; 
            background-color: #2a3942; 
            border: none; 
            padding: 12px; 
            border-radius: 25px; 
            color: white; 
            outline: none; 
        }

        .btn-mic { 
            background-color: #00a884; 
            border: none; 
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            color: white; 
            font-size: 22px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        /* Burbujas de audio */
        audio { margin-left: auto; filter: invert(100%); }
    </style>
</head>
<body>

    <div class="header">
        <span onclick="window.history.back()" style="cursor:pointer">‚Üê</span>
        <span>Soporte DNPlus</span>
    </div>

    <div id="chat-box"></div>

    <div class="footer">
        <input type="text" id="msg-input" placeholder="Mensaje">
        
        <button class="btn-mic" id="btn-audio" onclick="controlarVoz()">üéôÔ∏è</button>
    </div>

    <script>
        let grabador;
        let fragmentos = [];

        async function controlarVoz() {
            const boton = document.getElementById('btn-audio');
            
            if (!grabador || grabador.state === "inactive") {
                try {
                    const flujo = await navigator.mediaDevices.getUserMedia({ audio: true });
                    grabador = new MediaRecorder(flujo);
                    fragmentos = [];

                    grabador.ondataavailable = (e) => fragmentos.push(e.data);
                    
                    grabador.onstop = () => {
                        const blobAudio = new Blob(fragmentos, { type: 'audio/mp3' });
                        const urlAudio = URL.createObjectURL(blobAudio);
                        
                        // Crear el elemento de audio en el chat
                        const chat = document.getElementById('chat-box');
                        const nuevoAudio = document.createElement('audio');
                        nuevoAudio.src = urlAudio;
                        nuevoAudio.controls = true;
                        nuevoAudio.style.display = "block";
                        nuevoAudio.style.marginTop = "10px";
                        
                        chat.appendChild(nuevoAudio);
                        chat.scrollTop = chat.scrollHeight; // Baja el scroll autom√°ticamente
                    };

                    grabador.start();
                    boton.innerHTML = "üõë";
                    boton.style.backgroundColor = "#ff3b30";
                } catch (error) {
                    alert("David, por favor activa los permisos del micr√≥fono.");
                }
            } else {
                grabador.stop();
                boton.innerHTML = "üéôÔ∏è";
                boton.style.backgroundColor = "#00a884";
            }
        }
    </script>


   <script>
        let grabador;
    let fragmentos = [];

    // Esta funci√≥n decide si env√≠a TEXTO o graba AUDIO
    function enviarOgrabar() {
        const input = document.getElementById('msg-input');
        const mensaje = input.value.trim();

        if (mensaje !== "") {
            // SI HAY TEXTO: Lo env√≠a
            enviarTexto(mensaje);
            input.value = ""; // Limpia la barra
        } else {
            // SI EST√Å VAC√çO: Activa el micr√≥fono
            controlarVoz();
        }
    }

    function enviarTexto(texto) {
        const chat = document.getElementById('chat-box');
        const div = document.createElement('div');
        
        // Estilo de burbuja de texto con tu color favorito
        div.style.alignSelf = "flex-end";
        div.style.backgroundColor = "#176f47";
        div.style.color = "white";
        div.style.padding = "10px 15px";
        div.style.borderRadius = "15px 0px 15px 15px";
        div.style.maxWidth = "80%";
        div.style.marginBottom = "10px";
        div.style.fontSize = "16px";
        div.innerText = texto;

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight; // Baja el scroll
    }

    // Tu funci√≥n de voz que ya funcionaba, pero mejorada
    async function controlarVoz() {
        const boton = document.getElementById('btn-audio');
        if (!grabador || grabador.state === "inactive") {
            try {
                const flujo = await navigator.mediaDevices.getUserMedia({ audio: true });
                grabador = new MediaRecorder(flujo);
                fragmentos = [];
                grabador.ondataavailable = (e) => fragmentos.push(e.data);
                grabador.onstop = () => {
                    const blobAudio = new Blob(fragmentos, { type: 'audio/mp3' });
                    const urlAudio = URL.createObjectURL(blobAudio);
                    const chat = document.getElementById('chat-box');
                    
                    // Burbuja de audio verde
                    const divAudio = document.createElement('div');
                    divAudio.style.alignSelf = "flex-end";
                    divAudio.style.backgroundColor = "#176f47";
                    divAudio.style.padding = "10px";
                    divAudio.style.borderRadius = "15px 0px 15px 15px";
                    divAudio.style.marginBottom = "10px";
                    
                    const audio = document.createElement('audio');
                    audio.src = urlAudio;
                    audio.controls = true;
                    audio.style.width = "200px";
                    
                    divAudio.appendChild(audio);
                    chat.appendChild(divAudio);
                    chat.scrollTop = chat.scrollHeight;
                };
                grabador.start();
                boton.innerHTML = "üõë";
            } catch (error) { alert("Activa el micro, David."); }
        } else {
            grabador.stop();
            boton.innerHTML = "üéôÔ∏è";
        }
    }
</script>
</body>
</html>
