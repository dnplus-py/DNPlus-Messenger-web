<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNpPlus - Chat Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --whatsapp-teal: #075E54;
            --whatsapp-bg: #E5DDD5;
            --msg-mine: #176f47; 
            --msg-theirs: #ffffff;
            --text-color: #F08927; 
            --wa-blue: #34B7F1;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--whatsapp-bg); height: 100vh; display: flex; flex-direction: column; margin: 0; overflow: hidden; }

        header { background-color: var(--whatsapp-teal); color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        #chat-container {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: cover;
        }

        .bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 0.95rem; box-shadow: 0 1px 2px rgba(0,0,0,0.15); position: relative; }
        .bubble-mine { align-self: flex-end; background-color: var(--msg-mine); border-top-right-radius: 2px; color: white; }
        .bubble-theirs { align-self: flex-start; background-color: var(--msg-theirs); border-top-left-radius: 2px; color: #000; }
        
        .msg-text-custom { color: var(--text-color); font-weight: 500; }
        .msg-info { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 0.65rem; margin-top: 4px; opacity: 0.8; }
        .double-check { color: var(--wa-blue); }

        /* Men√∫ Ajustes Corregido */
        #menu-opciones { display: none; position: fixed; top: 55px; right: 10px; background: #232d36; border-radius: 8px; min-width: 150px; z-index: 5000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .menu-item { padding: 12px 20px; color: white; cursor: pointer; border-bottom: 1px solid #2d3a45; }
        
        /* Pantalla de Llamada */
        #call-screen { position: fixed; inset: 0; background: #0b141a; z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: space-between; padding: 70px 20px 80px; color: white; }
    </style>
</head>
<body>

    <div id="menu-opciones">
        <div class="menu-item" onclick="window.location.href='ajustes.html'">‚öôÔ∏è Ajustes</div>
        <div class="menu-item" onclick="location.reload()">üîÑ Actualizar</div>
        <div class="menu-item" style="color:#ff4444" onclick="cerrarSesion()">üö™ Salir</div>
    </div>

    <div id="call-screen">
        <div class="text-center">
            <h2 id="call-name" class="text-3xl font-light mb-1">Cargando...</h2>
            <div id="call-timer" class="text-sm opacity-80">Llamando...</div>
        </div>
        <img id="call-photo" src="" style="width:150px; height:150px; border-radius:50%; object-fit:cover;">
        <button class="bg-red-600 w-16 h-16 rounded-full flex items-center justify-center" onclick="endCall()">
            <i class="fas fa-phone-slash rotate-[135deg]"></i>
        </button>
    </div>

    <header>
        <div class="flex items-center">
            <i class="fas fa-arrow-left p-2 mr-1"></i>
            <img id="header-photo" src="" class="avatar">
            <div class="ml-3">
                <div id="header-name" class="font-bold text-sm">Cargando...</div>
                <div class="text-[11px] opacity-80">en l√≠nea</div>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <i class="fas fa-phone text-lg" onclick="startCall()"></i>
            <i class="fas fa-ellipsis-v text-lg cursor-pointer" onclick="toggleMenu()"></i>
        </div>
    </header>

    <main id="chat-container"></main>

    <div class="bg-[#f0f0f0] p-2 flex items-center gap-2">
        <div class="bg-white flex-1 rounded-full flex items-center px-4 h-12 shadow-sm">
            <i class="far fa-smile text-gray-500 text-2xl mr-2"></i>
            <input type="text" id="chat-input" class="flex-1 outline-none" placeholder="Mensaje">
            <i class="fas fa-paperclip text-gray-500 text-xl rotate-[-45deg]"></i>
        </div>
        <button class="w-12 h-12 rounded-full bg-[#075E54] text-white flex items-center justify-center" onclick="enviarMensaje()">
            <i id="action-icon" class="fas fa-microphone"></i>
        </button>
    </div>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const input = document.getElementById('chat-input');
        const icon = document.getElementById('action-icon');
        const container = document.getElementById('chat-container');

        // ID del contacto (puedes cambiarlo por el ID din√°mico que necesites)
        const contactoId = localStorage.getItem("chat_con_id") || "12345";

        window.onload = () => {
            // 1. CARGAR DATOS DEL PERFIL DEL CONTACTO DESDE FIREBASE
            db.ref("usuarios/" + contactoId).on("value", (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    document.getElementById('header-name').innerText = data.nombre || "Usuario";
                    document.getElementById('call-name').innerText = data.nombre || "Usuario";
                    const fotoUrl = data.foto || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                    document.getElementById('header-photo').src = fotoUrl;
                    document.getElementById('call-photo').src = fotoUrl;
                }
            });

            // 2. ESCUCHAR MENSAJES EN TIEMPO REAL
            db.ref("mensajes").limitToLast(20).on("child_added", (snapshot) => {
                const msg = snapshot.val();
                if (msg.usuario !== localStorage.getItem("user_phone")) {
                    dibujarBurbuja(msg.texto, msg.hora, false);
                }
            });
        };

        input.oninput = () => {
            icon.className = input.value.trim() ? "fas fa-paper-plane" : "fas fa-microphone";
        };

        function enviarMensaje() {
            const texto = input.value.trim();
            if(!texto) return;
            const hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const miTel = localStorage.getItem("user_phone") || "anonimo";

            db.ref("mensajes").push({ texto: texto, hora: hora, usuario: miTel });
            dibujarBurbuja(texto, hora, true);
            input.value = "";
            icon.className = "fas fa-microphone";
        }

        function dibujarBurbuja(texto, hora, esMio) {
            const b = document.createElement('div');
            b.className = esMio ? "bubble bubble-mine" : "bubble bubble-theirs";
            b.innerHTML = `
                <div class="${esMio ? 'msg-text-custom' : ''}">${texto}</div>
                <div class="msg-info">
                    <span>${hora}</span>
                    ${esMio ? '<i class="fas fa-check-double double-check"></i>' : ''}
                </div>`;
            container.appendChild(b);
            container.scrollTop = container.scrollHeight;
        }

        function toggleMenu() {
            const m = document.getElementById('menu-opciones');
            m.style.display = (m.style.display === 'block') ? 'none' : 'block';
        }

        function startCall() { document.getElementById('call-screen').style.display = 'flex'; }
        function endCall() { document.getElementById('call-screen').style.display = 'none'; }
        
        function cerrarSesion() {
            localStorage.clear();
            window.location.href = 'registro.html';
        }
    </script>
</body>
</html>
