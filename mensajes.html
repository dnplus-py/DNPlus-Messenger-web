<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DNpPlus - Chat Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --whatsapp-bg: #0b141a;
            --msg-mine: #176f47;
            --msg-theirs: #202c33;
            --text-color-mine: #F08927;
            --header-color: #085f56;
            --wa-blue: #34B7F1;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--whatsapp-bg); height: 100vh; display: flex; flex-direction: column; margin: 0; overflow: hidden; }
        header { height: 62px; background-color: var(--header-color); color: white; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 1000; }
        .header-left { display: flex; align-items: center; gap: 2px; flex: 1; }
        .header-info { display: flex; align-items: center; gap: 10px; padding: 5px; border-radius: 8px; cursor: pointer; }
        
        #chat-container {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; background-color: #0b141a;
        }

        .bubble { max-width: 90%; padding: 6px 10px; border-radius: 12px; font-size: 0.95rem; color: white; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .bubble-mine { align-self: flex-end; background-color: var(--msg-mine); border-top-right-radius: 2px; }
        .bubble-theirs { align-self: flex-start; background-color: var(--msg-theirs); border-top-left-radius: 2px; }
        .bubble-mine .text-content { color: var(--text-color-mine); font-weight: 500; }

        /* Estilo para Audio */
        .audio-player { display: flex; align-items: center; gap: 10px; min-width: 200px; padding: 5px; }
        .play-btn { font-size: 20px; cursor: pointer; color: white; }

        .input-area { background-color: #111b21; padding: 8px 10px; display: flex; align-items: center; gap: 8px; position: relative; }
        .input-card { background: #2a3942; border-radius: 25px; flex: 1; display: flex; align-items: center; padding: 0 15px; height: 48px; }
        .input-card input { background: transparent; border: none; outline: none; flex: 1; color: white; }
        .action-btn { background: var(--msg-mine); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: none; }
        
        #call-screen { position: fixed; inset: 0; background: #075e54; z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: space-between; padding: 60px 0; color: white; }
        #rec-overlay { position: absolute; left: 10px; right: 70px; top: 8px; bottom: 8px; background: #111b21; border-radius: 25px; display: none; align-items: center; padding: 0 20px; z-index: 10; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <i class="fas fa-arrow-left p-2 cursor-pointer" onclick="history.back()"></i>
            <div class="header-info">
                <img id="header-photo" src="" class="avatar">
                <div>
                    <div id="header-name" class="font-bold">Cargando...</div>
                    <div id="header-status" class="text-[12px] opacity-70">en línea</div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-6 pr-2">
            <i class="fas fa-phone text-lg cursor-pointer" onclick="startCall()"></i>
            <i class="fas fa-ellipsis-v text-lg cursor-pointer" onclick="toggleMenu()"></i>
        </div>
    </header>

    <main id="chat-container"></main>

    <div class="input-area">
        <div id="rec-overlay">
            <i class="fas fa-microphone text-red-500 animate-pulse mr-3"></i>
            <span id="rec-timer" class="text-white flex-1">0:00</span>
            <span class="text-red-400 text-xs">Grabando... suelta para enviar</span>
        </div>
        <div class="input-card">
            <i class="far fa-smile text-[#8696a0] mr-3"></i>
            <input type="text" id="chat-input" placeholder="Mensaje">
        </div>
        <button id="action-btn" class="action-btn"><i id="action-icon" class="fas fa-microphone"></i></button>
    </div>

    <div id="call-screen">
        <div class="text-center">
            <img id="call-photo" src="" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover">
            <div id="call-name" class="text-2xl font-bold">Nombre</div>
            <div id="call-status" class="mt-2">Llamando...</div>
        </div>
        <div class="bg-red-500 w-16 h-16 rounded-full flex items-center justify-center text-2xl cursor-pointer" onclick="endCall()">
            <i class="fas fa-phone-slash"></i>
        </div>
    </header>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const miId = localStorage.getItem("user_phone") || "595992536184";
        const idOtro = localStorage.getItem("chat_destinatario_id");
        const salaId = localStorage.getItem("chat_sala_id");

        // 1. NOTIFICACIÓN DE MENSAJES NUEVOS (Listener)
        db.ref("chats_privados/" + salaId).limitToLast(1).on("child_added", (snap) => {
            const data = snap.val();
            if(data.emisor !== miId) {
                // Si el mensaje no es mío, vibrar o sonar
                if(navigator.vibrate) navigator.vibrate(100);
                // Aquí podrías añadir un sonido: new Audio('pop.mp3').play();
            }
            dibujarBurbuja(data);
        });

        // 2. LÓGICA DE GRABACIÓN DE VOZ REAL
        let mediaRecorder;
        let audioChunks = [];

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = () => {
                    const base64Audio = reader.result;
                    sendData({ tipo: 'audio', url: base64Audio, duracion: document.getElementById('rec-timer').innerText });
                };
            };
            mediaRecorder.start();
        }

        function stopRecording(send) {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        // 3. LÓGICA DE LLAMADA (Sincronizada con Firebase)
        function startCall() {
            document.getElementById('call-screen').style.display = 'flex';
            // Avisar al otro que estamos llamando
            db.ref("llamadas/" + idOtro).set({
                emisor: miId,
                nombre: localStorage.getItem("user_nombre") || "David",
                status: 'llamando',
                fecha: Date.now()
            });
        }

        function endCall() {
            document.getElementById('call-screen').style.display = 'none';
            db.ref("llamadas/" + idOtro).remove();
        }

        // Listener para recibir llamadas
        db.ref("llamadas/" + miId).on("value", (snap) => {
            if(snap.exists()) {
                const callData = snap.val();
                document.getElementById('call-name').innerText = callData.nombre;
                document.getElementById('call-screen').style.display = 'flex';
                document.getElementById('call-status').innerText = "Llamada entrante...";
            } else {
                document.getElementById('call-screen').style.display = 'none';
            }
        });

        // FUNCIONES DE SOPORTE
        function sendData(payload) {
            db.ref("chats_privados/" + salaId).push({
                ...payload,
                emisor: miId,
                hora: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                fecha: Date.now()
            });
        }

        function dibujarBurbuja(data) {
            const esMio = data.emisor === miId;
            const container = document.getElementById('chat-container');
            const b = document.createElement('div');
            b.className = `bubble ${esMio ? 'bubble-mine' : 'bubble-theirs'}`;
            
            if(data.tipo === 'audio') {
                b.innerHTML = `
                    <div class="audio-player">
                        <i class="fas fa-play play-btn" onclick="playAudio('${data.url}', this)"></i>
                        <div class="text-xs opacity-80">Mensaje de voz (${data.duracion})</div>
                    </div>`;
            } else {
                b.innerHTML = `<div class="${esMio ? 'text-content' : ''}">${data.mensaje || ''}</div>`;
            }
            
            b.innerHTML += `<div class="msg-info"><span>${data.hora}</span></div>`;
            container.appendChild(b);
            container.scrollTop = container.scrollHeight;
        }

        function playAudio(url, btn) {
            const audio = new Audio(url);
            audio.play();
            btn.classList.replace('fa-play', 'fa-pause');
            audio.onended = () => btn.classList.replace('fa-pause', 'fa-play');
        }

        // Eventos del Botón de Acción
        let timer;
        const btn = document.getElementById('action-btn');
        btn.onmousedown = (e) => {
            if(!document.getElementById('chat-input').value) {
                timer = setTimeout(() => {
                    document.getElementById('rec-overlay').style.display = 'flex';
                    startRecording();
                }, 200);
            }
        };
        btn.onmouseup = () => {
            clearTimeout(timer);
            if(document.getElementById('rec-overlay').style.display === 'flex') {
                stopRecording(true);
                document.getElementById('rec-overlay').style.display = 'none';
            } else {
                const msg = document.getElementById('chat-input').value;
                if(msg) {
                    sendData({ tipo: 'texto', mensaje: msg });
                    document.getElementById('chat-input').value = "";
                }
            }
        };
    </script>
</body>
</html>
