<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llamada DNPlus</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        body { background-color: #0b141a; overflow: hidden; color: white; }
        .pulse-animation { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(23, 111, 71, 0.7); }
            70% { box-shadow: 0 0 0 30px rgba(23, 111, 71, 0); }
            100% { box-shadow: 0 0 0 0 rgba(23, 111, 71, 0); }
        }
        .btn-call {
            width: 55px; height: 55px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background-color: rgba(31, 41, 55, 0.6); font-size: 20px;
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-between py-16">

    <div class="text-center">
        <div class="flex items-center justify-center gap-2 mb-2">
            <i class="fas fa-lock text-[10px] text-gray-500"></i>
            <p class="text-[11px] text-gray-400 uppercase tracking-[2px]">Cifrado de extremo a extremo</p>
        </div>
        <h1 id="nombre-contacto" class="text-3xl font-medium mt-4">Cargando...</h1>
        <p id="timer" class="text-gray-400 mt-2 text-lg">Llamando...</p>
    </div>

    <div class="relative">
        <img id="foto-contacto" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" 
             class="w-48 h-48 rounded-full object-cover border-4 border-[#176f47] pulse-animation">
    </div>

    <div class="flex flex-col items-center gap-10 w-full px-10">
        <div class="flex justify-around w-full max-w-sm">
            <button class="btn-call"><i class="fas fa-volume-up"></i></button>
            <button class="btn-call"><i class="fas fa-video-slash"></i></button>
            <button class="btn-call"><i class="fas fa-microphone"></i></button>
        </div>

        <button onclick="window.history.back()" class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center text-2xl shadow-2xl">
            <i class="fas fa-phone-slash rotate-[135deg]"></i>
        </button>
    </div>

    <script>
        // CONFIGURACI칍N OBTENIDA DE TUS CAPTURAS
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            projectId: "dnplus-messenger-pro",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // IMPORTANTE: Pon tu Server Key aqu칤 para que el env칤o sea real
        const SERVER_KEY = "TU_SERVER_KEY_AQUI"; 

        const idDestino = new URLSearchParams(window.location.search).get('id') || localStorage.getItem("chat_destinatario_id");
        const miNombre = localStorage.getItem("user_name") || "Alguien";

        if (idDestino) {
            // Buscamos al usuario en la base de datos
            db.ref("usuarios_registrados/" + idDestino).once("value", (snap) => {
                const user = snap.val();
                if (user) {
                    document.getElementById("nombre-contacto").innerText = user.nombre || "Usuario";
                    if (user.foto) document.getElementById("foto-contacto").src = user.foto;
                    
                    // Si el usuario tiene un token de notificaci칩n, le enviamos el aviso real
                    if (user.fcm_token) {
                        ejecutarLlamadaReal(user.fcm_token, miNombre);
                    }
                }
            });
        }

        async function ejecutarLlamadaReal(token, emisor) {
            const payload = {
                "to": token,
                "notification": {
                    "title": "游 Llamada de DNPlus",
                    "body": emisor + " te est치 llamando...",
                    "icon": "https://dnplus-py.github.io/DNPlus-Messenger-web/icono.png",
                    "click_action": "https://dnplus-py.github.io/DNPlus-Messenger-web/llamada.html"
                },
                "priority": "high"
            };

            await fetch('https://fcm.googleapis.com/fcm/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'key=' + SERVER_KEY
                },
                body: JSON.stringify(payload)
            });
        }

        // Simulaci칩n de cron칩metro al "conectar"
        setTimeout(() => {
            let s = 0;
            const t = document.getElementById("timer");
            t.style.color = "#00a884";
            setInterval(() => {
                s++;
                let m = Math.floor(s / 60);
                t.innerText = `${m < 10 ? '0'+m : m}:${(s % 60) < 10 ? '0'+(s % 60) : (s % 60)}`;
            }, 1000);
        }, 3000);
    </script>
</body>
</html>
