<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación - DNPlus</title>
    <style>
        body { background-color: #0b141a; color: white; text-align: center; font-family: sans-serif; padding: 20px; }
        .title { color: #e9edef; margin-top: 50px; font-size: 20px; }
        .instruccion { color: #8696a0; font-size: 14px; margin: 20px 0; }
        .otp-input { background: transparent; border: none; border-bottom: 2px solid #176f47; color: white; font-size: 24px; width: 150px; text-align: center; outline: none; letter-spacing: 5px; }
        .btn-verificar { background: #176f47; color: white; padding: 12px 50px; border-radius: 30px; border: none; margin-top: 40px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <h2 class="title">Verifica tu código</h2>
    <p class="instruccion" id="info-tel">Hemos enviado un código al número registrado.</p>

    <input type="number" id="otpInp" class="otp-input" placeholder="000000">
    <br>
    <button class="btn-verificar" onclick="verificarCodigo()">SIGUIENTE</button>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD2nZF5QC-Zti80xP1A518qbUPnhRru_9A",
            databaseURL: "https://dnplus-messenger-pro-default-rtdb.firebaseio.com",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Recuperamos el número que guardamos en el paso anterior
        const telRegistro = localStorage.getItem("user_phone");

        // SI NO HAY NÚMERO, esto es lo que te manda a términos. 
        // Lo arreglamos para que solo avise, no que te eche de una.
        if(!telRegistro) {
            alert("No se encontró el número de registro. Volviendo al inicio.");
            window.location.href = "registro.html"; // O el nombre de tu archivo de términos/número
        } else {
            document.getElementById('info-tel').innerText = "Verificando el número: +" + telRegistro;
        }

        function verificarCodigo() {
            const codigo = document.getElementById('otpInp').value;
            
            // Simulación de verificación (aquí iría tu lógica de Firebase Auth o Email)
            if(codigo.length >= 4) {
                // GUARDADO DEFINITIVO usando el NÚMERO como ID ✅
                db.ref("usuarios_registrados/" + telRegistro).update({
                    telefono: telRegistro,
                    verificado: true,
                    fecha_verificacion: new Date().toLocaleString()
                }).then(() => {
                    // Guardamos el ID de sesión para que lista_chats no falle
                    localStorage.setItem("chat_destId", telRegistro);
                    
                    // AVANZAMOS AL PERFIL
                    window.location.href = "add_perfil.html";
                }).catch(e => alert("Error: " + e.message));
            } else {
                alert("Introduce un código válido.");
            }
        }
    </script>
</body>
</html>
